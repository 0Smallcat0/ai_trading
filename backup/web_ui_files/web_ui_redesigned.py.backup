#!/usr/bin/env python3
"""
AIäº¤æ˜“ç³»çµ± - é‡æ–°è¨­è¨ˆçš„ Web UI (å…¨æ–° UX/UI è¨­è¨ˆ)

å…¨é¢é‡æ–°è¨­è¨ˆçš„ç”¨æˆ¶ä»‹é¢ï¼Œå°ˆæ³¨æ–¼ï¼š
- ç›´è§€çš„å„€è¡¨æ¿è¨­è¨ˆ
- é›¶åŸºç¤ç”¨æˆ¶å‹å¥½
- å³æ™‚äº¤æ˜“ç‹€æ³å±•ç¤º
- æ•´åˆå¼åŠŸèƒ½æ¨¡çµ„
- éŸ¿æ‡‰å¼è¨­è¨ˆ

ç‰ˆæœ¬: v3.0 Redesigned
ç‹€æ…‹: ğŸ¨ å…¨æ–°è¨­è¨ˆ
æœ€å¾Œæ›´æ–°: 2025-01-16

ä½¿ç”¨æ–¹å¼:
    python -m streamlit run src/ui/web_ui_redesigned.py --server.address=127.0.0.1 --server.port=8501
"""

import os
import sys
import logging
import importlib.util
from typing import Dict, Any, Optional, List
from datetime import datetime, timedelta

# æ·»åŠ å°ˆæ¡ˆæ ¹ç›®éŒ„åˆ°Pythonè·¯å¾‘
project_root = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, project_root)
sys.path.insert(0, os.path.join(project_root, 'src'))

import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
import numpy as np

# è¨­å®šæ—¥èªŒ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def setup_page_config():
    """è¨­å®šé é¢é…ç½®"""
    st.set_page_config(
        page_title="AI Trading System - æ™ºèƒ½äº¤æ˜“å¹³å°",
        page_icon="ğŸš€",
        layout="wide",
        initial_sidebar_state="collapsed"  # é è¨­æ”¶åˆå´é‚Šæ¬„
    )

def apply_custom_css():
    """æ‡‰ç”¨è‡ªå®šç¾© CSS æ¨£å¼"""
    st.markdown("""
    <style>
    /* ä¸»è¦å®¹å™¨æ¨£å¼ */
    .main-container {
        padding: 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        margin-bottom: 1rem;
    }
    
    /* å¡ç‰‡æ¨£å¼ */
    .metric-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
    }
    
    /* åŠŸèƒ½æ¨¡çµ„å¡ç‰‡ */
    .function-card {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin: 0.5rem;
        transition: transform 0.2s;
        cursor: pointer;
    }
    
    .function-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-active { background-color: #4CAF50; }
    .status-warning { background-color: #FF9800; }
    .status-error { background-color: #F44336; }
    .status-inactive { background-color: #9E9E9E; }
    
    /* å°èˆªæŒ‰éˆ• */
    .nav-button {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        margin: 0.2rem;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .nav-button:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    /* æ–°æ‰‹æç¤º */
    .beginner-tip {
        background: #E3F2FD;
        border-left: 4px solid #2196F3;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 0 5px 5px 0;
    }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
        .metric-card {
            padding: 1rem;
        }
        .function-card {
            margin: 0.25rem;
            padding: 0.75rem;
        }
    }
    </style>
    """, unsafe_allow_html=True)

def show_welcome_header():
    """é¡¯ç¤ºæ­¡è¿æ¨™é¡Œå€åŸŸ"""
    current_time = datetime.now()
    
    # ä¸»æ¨™é¡Œå€åŸŸ
    st.markdown("""
    <div class="main-container">
        <h1 style="color: white; margin: 0; font-size: 2.5rem;">
            ğŸš€ AIæ™ºèƒ½äº¤æ˜“å¹³å°
        </h1>
        <p style="color: rgba(255,255,255,0.9); margin: 0.5rem 0 0 0; font-size: 1.1rem;">
            æ­¡è¿å›ä¾†ï¼è®“æˆ‘å€‘ä¸€èµ·æ¢ç´¢æ™ºèƒ½äº¤æ˜“çš„ä¸–ç•Œ
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # å¿«é€Ÿç‹€æ…‹æ¬„
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.markdown("""
        <div class="metric-card">
            <div style="display: flex; align-items: center;">
                <span class="status-indicator status-active"></span>
                <strong>ç³»çµ±ç‹€æ…‹</strong>
            </div>
            <div style="font-size: 1.2rem; color: #4CAF50; margin-top: 0.5rem;">
                âœ… é‹è¡Œæ­£å¸¸
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    with col2:
        st.markdown(f"""
        <div class="metric-card">
            <div style="display: flex; align-items: center;">
                <span class="status-indicator status-active"></span>
                <strong>å¸‚å ´ç‹€æ…‹</strong>
            </div>
            <div style="font-size: 1.2rem; color: #2196F3; margin-top: 0.5rem;">
                ğŸ“ˆ é–‹ç›¤ä¸­
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    with col3:
        st.markdown("""
        <div class="metric-card">
            <div style="display: flex; align-items: center;">
                <span class="status-indicator status-warning"></span>
                <strong>æ´»èºç­–ç•¥</strong>
            </div>
            <div style="font-size: 1.2rem; color: #FF9800; margin-top: 0.5rem;">
                âš¡ 3 å€‹é‹è¡Œä¸­
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    with col4:
        st.markdown(f"""
        <div class="metric-card">
            <div style="display: flex; align-items: center;">
                <span class="status-indicator status-active"></span>
                <strong>ç•¶å‰æ™‚é–“</strong>
            </div>
            <div style="font-size: 1.2rem; color: #666; margin-top: 0.5rem;">
                ğŸ• {current_time.strftime('%H:%M:%S')}
            </div>
        </div>
        """, unsafe_allow_html=True)

def show_portfolio_overview():
    """é¡¯ç¤ºæŠ•è³‡çµ„åˆæ¦‚è¦½"""
    st.markdown("## ğŸ’¼ æŠ•è³‡çµ„åˆæ¦‚è¦½")
    
    # æ¨¡æ“¬æŠ•è³‡çµ„åˆæ•¸æ“š
    portfolio_value = 1250000
    daily_change = 15600
    daily_change_pct = 1.26
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            label="ç¸½è³‡ç”¢åƒ¹å€¼",
            value=f"${portfolio_value:,}",
            delta=f"${daily_change:,}"
        )
    
    with col2:
        st.metric(
            label="ä»Šæ—¥æ”¶ç›Šç‡",
            value=f"{daily_change_pct:+.2f}%",
            delta=f"{daily_change_pct:+.2f}%"
        )
    
    with col3:
        st.metric(
            label="æŒå€‰æ•¸é‡",
            value="8",
            delta="0"
        )
    
    with col4:
        st.metric(
            label="å¯ç”¨ç¾é‡‘",
            value="$125,000",
            delta="-$5,000"
        )
    
    # æŠ•è³‡çµ„åˆåˆ†ä½ˆåœ–
    col1, col2 = st.columns([2, 1])
    
    with col1:
        # å‰µå»ºæŠ•è³‡çµ„åˆåƒ¹å€¼è¶¨å‹¢åœ–
        dates = pd.date_range(start=datetime.now() - timedelta(days=30), end=datetime.now(), freq='D')
        values = np.cumsum(np.random.randn(len(dates)) * 5000) + 1200000
        
        fig = go.Figure()
        fig.add_trace(go.Scatter(
            x=dates,
            y=values,
            mode='lines',
            name='æŠ•è³‡çµ„åˆåƒ¹å€¼',
            line=dict(color='#667eea', width=3)
        ))
        
        fig.update_layout(
            title="30å¤©æŠ•è³‡çµ„åˆåƒ¹å€¼è¶¨å‹¢",
            xaxis_title="æ—¥æœŸ",
            yaxis_title="åƒ¹å€¼ ($)",
            height=300,
            showlegend=False
        )
        
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        # è³‡ç”¢åˆ†ä½ˆé¤…åœ–
        holdings = {
            'AAPL': 25,
            'TSLA': 20,
            'MSFT': 15,
            'GOOGL': 12,
            'NVDA': 10,
            'å…¶ä»–': 18
        }
        
        fig_pie = px.pie(
            values=list(holdings.values()),
            names=list(holdings.keys()),
            title="è³‡ç”¢åˆ†ä½ˆ"
        )
        
        fig_pie.update_layout(height=300)
        st.plotly_chart(fig_pie, use_container_width=True)

def show_quick_actions():
    """é¡¯ç¤ºå¿«é€Ÿæ“ä½œå€åŸŸ"""
    st.markdown("## âš¡ å¿«é€Ÿæ“ä½œ")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        if st.button("ğŸ¯ æ–°å»ºç­–ç•¥", use_container_width=True, type="primary"):
            st.session_state.current_view = "strategy_management"
            st.rerun()
    
    with col2:
        if st.button("ğŸ“Š æŸ¥çœ‹å›æ¸¬", use_container_width=True):
            st.session_state.current_view = "backtest"
            st.rerun()
    
    with col3:
        if st.button("âš ï¸ é¢¨éšªç›£æ§", use_container_width=True):
            st.session_state.current_view = "risk_management"
            st.rerun()
    
    with col4:
        if st.button("ğŸ“ˆ å¸‚å ´åˆ†æ", use_container_width=True):
            st.session_state.current_view = "market_analysis"
            st.rerun()

def show_beginner_guide():
    """é¡¯ç¤ºæ–°æ‰‹å¼•å°"""
    if st.session_state.get("show_beginner_guide", True):
        st.markdown("""
        <div class="beginner-tip">
            <h4>ğŸ’¡ æ–°æ‰‹æç¤º</h4>
            <p>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½äº¤æ˜“å¹³å°ï¼é€™è£¡æ˜¯æ‚¨çš„å°ˆå±¬äº¤æ˜“åŠ©æ‰‹ã€‚</p>
            <ul>
                <li><strong>æŠ•è³‡çµ„åˆæ¦‚è¦½</strong>ï¼šæŸ¥çœ‹æ‚¨çš„è³‡ç”¢ç‹€æ³å’Œæ”¶ç›Šè¡¨ç¾</li>
                <li><strong>å¿«é€Ÿæ“ä½œ</strong>ï¼šä¸€éµè¨ªå•å¸¸ç”¨åŠŸèƒ½</li>
                <li><strong>åŠŸèƒ½æ¨¡çµ„</strong>ï¼šæ¢ç´¢æ›´å¤šé«˜ç´šåŠŸèƒ½</li>
            </ul>
        </div>
        """, unsafe_allow_html=True)

        if st.button("æˆ‘å·²äº†è§£ï¼Œä¸å†é¡¯ç¤º", key="hide_beginner_guide"):
            st.session_state.show_beginner_guide = False
            st.rerun()

def get_function_modules():
    """ç²å–åŠŸèƒ½æ¨¡çµ„é…ç½®"""
    return {
        "core_functions": {
            "title": "ğŸ¯ æ ¸å¿ƒåŠŸèƒ½",
            "modules": [
                {
                    "key": "strategy_management",
                    "title": "ç­–ç•¥ç®¡ç†",
                    "icon": "ğŸ¯",
                    "description": "å‰µå»ºã€ç·¨è¼¯å’Œç®¡ç†äº¤æ˜“ç­–ç•¥",
                    "status": "active",
                    "quick_actions": ["æ–°å»ºç­–ç•¥", "ç­–ç•¥åˆ—è¡¨", "ç­–ç•¥å„ªåŒ–"]
                },
                {
                    "key": "backtest",
                    "title": "å›æ¸¬åˆ†æ",
                    "icon": "ğŸ“Š",
                    "description": "æ¸¬è©¦ç­–ç•¥æ­·å²è¡¨ç¾",
                    "status": "active",
                    "quick_actions": ["é–‹å§‹å›æ¸¬", "çµæœåˆ†æ", "åƒæ•¸å„ªåŒ–"]
                },
                {
                    "key": "portfolio_management",
                    "title": "æŠ•è³‡çµ„åˆ",
                    "icon": "ğŸ’¼",
                    "description": "ç®¡ç†å’Œå„ªåŒ–æŠ•è³‡çµ„åˆ",
                    "status": "active",
                    "quick_actions": ["è³‡ç”¢é…ç½®", "é¢¨éšªåˆ†æ", "å†å¹³è¡¡"]
                },
                {
                    "key": "risk_management",
                    "title": "é¢¨éšªæ§åˆ¶",
                    "icon": "âš ï¸",
                    "description": "ç›£æ§å’Œæ§åˆ¶æŠ•è³‡é¢¨éšª",
                    "status": "warning",
                    "quick_actions": ["é¢¨éšªç›£æ§", "è­¦å ±è¨­ç½®", "ç·Šæ€¥åœæ"]
                }
            ]
        },
        "advanced_functions": {
            "title": "ğŸ¤– é«˜ç´šåŠŸèƒ½",
            "modules": [
                {
                    "key": "ai_models",
                    "title": "AI æ¨¡å‹",
                    "icon": "ğŸ¤–",
                    "description": "æ©Ÿå™¨å­¸ç¿’æ¨¡å‹è¨“ç·´å’Œé æ¸¬",
                    "status": "active",
                    "quick_actions": ["æ¨¡å‹è¨“ç·´", "é æ¸¬åˆ†æ", "æ¨¡å‹è©•ä¼°"]
                },
                {
                    "key": "text_analysis",
                    "title": "æ–‡æœ¬åˆ†æ",
                    "icon": "ğŸ“",
                    "description": "æ–°èæƒ…æ„Ÿåˆ†æå’Œå¸‚å ´æƒ…ç·’",
                    "status": "active",
                    "quick_actions": ["æƒ…æ„Ÿåˆ†æ", "æ–°èç›£æ§", "å¸‚å ´æƒ…ç·’"]
                },
                {
                    "key": "trade_execution",
                    "title": "äº¤æ˜“åŸ·è¡Œ",
                    "icon": "ğŸš€",
                    "description": "è‡ªå‹•åŒ–äº¤æ˜“åŸ·è¡Œ",
                    "status": "inactive",
                    "quick_actions": ["æ‰‹å‹•äº¤æ˜“", "è‡ªå‹•åŸ·è¡Œ", "è¨‚å–®ç®¡ç†"]
                },
                {
                    "key": "system_monitoring",
                    "title": "ç³»çµ±ç›£æ§",
                    "icon": "ğŸ“ˆ",
                    "description": "ç³»çµ±æ€§èƒ½å’Œç‹€æ…‹ç›£æ§",
                    "status": "active",
                    "quick_actions": ["æ€§èƒ½ç›£æ§", "æ—¥èªŒæŸ¥çœ‹", "è­¦å ±ç®¡ç†"]
                }
            ]
        },
        "data_functions": {
            "title": "ğŸ“Š æ•¸æ“šåŠŸèƒ½",
            "modules": [
                {
                    "key": "data_management",
                    "title": "æ•¸æ“šç®¡ç†",
                    "icon": "ğŸ“ˆ",
                    "description": "æ•¸æ“šè¼‰å…¥ã€æ¸…ç†å’Œç®¡ç†",
                    "status": "active",
                    "quick_actions": ["æ•¸æ“šå°å…¥", "æ•¸æ“šæ¸…ç†", "æ•¸æ“šæŸ¥çœ‹"]
                },
                {
                    "key": "feature_engineering",
                    "title": "ç‰¹å¾µå·¥ç¨‹",
                    "icon": "ğŸ”§",
                    "description": "æŠ€è¡“æŒ‡æ¨™å’Œç‰¹å¾µè¨ˆç®—",
                    "status": "active",
                    "quick_actions": ["æŒ‡æ¨™è¨ˆç®—", "ç‰¹å¾µé¸æ“‡", "æ•¸æ“šè½‰æ›"]
                },
                {
                    "key": "reports",
                    "title": "å ±å‘Šåˆ†æ",
                    "icon": "ğŸ“‹",
                    "description": "ç”Ÿæˆäº¤æ˜“å ±å‘Šå’Œåˆ†æ",
                    "status": "active",
                    "quick_actions": ["ç¸¾æ•ˆå ±å‘Š", "é¢¨éšªå ±å‘Š", "äº¤æ˜“è¨˜éŒ„"]
                }
            ]
        }
    }

def show_function_modules():
    """é¡¯ç¤ºåŠŸèƒ½æ¨¡çµ„"""
    st.markdown("## ğŸ”§ åŠŸèƒ½æ¨¡çµ„")

    modules_config = get_function_modules()

    for category_key, category in modules_config.items():
        st.markdown(f"### {category['title']}")

        # ä½¿ç”¨åˆ—ä½ˆå±€é¡¯ç¤ºæ¨¡çµ„
        cols = st.columns(len(category['modules']))

        for i, module in enumerate(category['modules']):
            with cols[i]:
                # ç‹€æ…‹æŒ‡ç¤ºå™¨
                status_class = f"status-{module['status']}"
                status_text = {
                    "active": "é‹è¡Œä¸­",
                    "warning": "éœ€æ³¨æ„",
                    "error": "éŒ¯èª¤",
                    "inactive": "æœªå•Ÿç”¨"
                }.get(module['status'], "æœªçŸ¥")

                # æ¨¡çµ„å¡ç‰‡
                st.markdown(f"""
                <div class="function-card">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">
                            {module['icon']}
                        </div>
                        <h4 style="margin: 0.5rem 0;">{module['title']}</h4>
                        <p style="color: #666; font-size: 0.9rem; margin: 0.5rem 0;">
                            {module['description']}
                        </p>
                        <div style="margin-top: 1rem;">
                            <span class="status-indicator {status_class}"></span>
                            <small>{status_text}</small>
                        </div>
                    </div>
                </div>
                """, unsafe_allow_html=True)

                # å¿«é€Ÿæ“ä½œæŒ‰éˆ•
                if st.button(f"é€²å…¥ {module['title']}", key=f"enter_{module['key']}", use_container_width=True):
                    st.session_state.current_view = module['key']
                    st.rerun()

                # å¿«é€Ÿæ“ä½œä¸‹æ‹‰é¸å–®
                with st.expander(f"å¿«é€Ÿæ“ä½œ", expanded=False):
                    for action in module['quick_actions']:
                        if st.button(action, key=f"quick_{module['key']}_{action}", use_container_width=True):
                            st.session_state.current_view = module['key']
                            st.session_state.quick_action = action
                            st.rerun()

        st.markdown("---")

def show_market_overview():
    """é¡¯ç¤ºå¸‚å ´æ¦‚æ³"""
    st.markdown("## ğŸ“ˆ å¸‚å ´æ¦‚æ³")

    # æ¨¡æ“¬å¸‚å ´æ•¸æ“š
    market_data = {
        "ä¸Šè­‰æŒ‡æ•¸": {"value": 3245.67, "change": +12.34, "change_pct": +0.38},
        "æ·±è­‰æˆæŒ‡": {"value": 12456.78, "change": -23.45, "change_pct": -0.19},
        "å‰µæ¥­æ¿æŒ‡": {"value": 2567.89, "change": +45.67, "change_pct": +1.81},
        "æ†ç”ŸæŒ‡æ•¸": {"value": 18234.56, "change": -67.89, "change_pct": -0.37}
    }

    cols = st.columns(len(market_data))

    for i, (index_name, data) in enumerate(market_data.items()):
        with cols[i]:
            delta_color = "normal" if data["change"] >= 0 else "inverse"
            st.metric(
                label=index_name,
                value=f"{data['value']:.2f}",
                delta=f"{data['change']:+.2f} ({data['change_pct']:+.2f}%)",
                delta_color=delta_color
            )

    # å¸‚å ´ç†±é»
    col1, col2 = st.columns([2, 1])

    with col1:
        st.markdown("### ğŸ“Š ä»Šæ—¥å¸‚å ´ç†±é»")

        # å‰µå»ºç†±é»è‚¡ç¥¨è¡¨æ ¼
        hot_stocks = pd.DataFrame({
            "è‚¡ç¥¨ä»£ç¢¼": ["000001", "000002", "600036", "600519", "000858"],
            "è‚¡ç¥¨åç¨±": ["å¹³å®‰éŠ€è¡Œ", "è¬ç§‘A", "æ‹›å•†éŠ€è¡Œ", "è²´å·èŒ…å°", "äº”ç³§æ¶²"],
            "ç¾åƒ¹": [12.34, 23.45, 45.67, 1890.12, 234.56],
            "æ¼²è·Œå¹…": ["+5.67%", "-2.34%", "+3.45%", "+1.23%", "+4.56%"],
            "æˆäº¤é‡": ["1.2å„„", "8900è¬", "5600è¬", "234è¬", "3400è¬"]
        })

        # æ·»åŠ é¡è‰²æ¨™è¨˜
        def color_change(val):
            if val.startswith('+'):
                return 'color: red'
            elif val.startswith('-'):
                return 'color: green'
            return ''

        styled_df = hot_stocks.style.applymap(color_change, subset=['æ¼²è·Œå¹…'])
        st.dataframe(styled_df, use_container_width=True, hide_index=True)

    with col2:
        st.markdown("### ğŸ“° å¸‚å ´è³‡è¨Š")

        news_items = [
            {"time": "09:30", "title": "å¤®è¡Œå®£å¸ƒé™æº–0.25å€‹ç™¾åˆ†é»", "type": "é‡è¦"},
            {"time": "10:15", "title": "ç§‘æŠ€è‚¡é›†é«”ä¸Šæ¼²", "type": "è¡Œæ¥­"},
            {"time": "11:00", "title": "å¤–è³‡æ·¨æµå…¥50å„„å…ƒ", "type": "è³‡é‡‘"},
            {"time": "14:30", "title": "æ–°èƒ½æºæ¿å¡Šæ´»èº", "type": "æ¿å¡Š"},
            {"time": "15:00", "title": "Aè‚¡æ”¶ç›¤ä¸Šæ¼²1.2%", "type": "å¸‚å ´"}
        ]

        for news in news_items:
            type_color = {
                "é‡è¦": "ğŸ”´",
                "è¡Œæ¥­": "ğŸŸ¡",
                "è³‡é‡‘": "ğŸŸ¢",
                "æ¿å¡Š": "ğŸ”µ",
                "å¸‚å ´": "ğŸŸ£"
            }.get(news["type"], "âšª")

            st.markdown(f"""
            <div style="padding: 0.5rem; margin: 0.25rem 0; background: #f8f9fa; border-radius: 5px;">
                <div style="font-size: 0.8rem; color: #666;">{news['time']} {type_color} {news['type']}</div>
                <div style="font-weight: 500;">{news['title']}</div>
            </div>
            """, unsafe_allow_html=True)

def show_recent_activities():
    """é¡¯ç¤ºæœ€è¿‘æ´»å‹•"""
    st.markdown("## ğŸ“‹ æœ€è¿‘æ´»å‹•")

    col1, col2 = st.columns(2)

    with col1:
        st.markdown("### ğŸ¯ ç­–ç•¥å‹•æ…‹")

        activities = [
            {"time": "2å°æ™‚å‰", "action": "å‰µå»º", "target": "å‹•é‡ç­–ç•¥ v2.1", "status": "æˆåŠŸ"},
            {"time": "4å°æ™‚å‰", "action": "å›æ¸¬", "target": "å‡å€¼å›æ­¸ç­–ç•¥", "status": "å®Œæˆ"},
            {"time": "6å°æ™‚å‰", "action": "å„ªåŒ–", "target": "å¤šå› å­ç­–ç•¥", "status": "é€²è¡Œä¸­"},
            {"time": "8å°æ™‚å‰", "action": "éƒ¨ç½²", "target": "å¥—åˆ©ç­–ç•¥", "status": "æˆåŠŸ"},
            {"time": "1å¤©å‰", "action": "æ›´æ–°", "target": "é¢¨éšªæ§åˆ¶åƒæ•¸", "status": "æˆåŠŸ"}
        ]

        for activity in activities:
            status_icon = {
                "æˆåŠŸ": "âœ…",
                "å®Œæˆ": "âœ…",
                "é€²è¡Œä¸­": "ğŸ”„",
                "å¤±æ•—": "âŒ",
                "è­¦å‘Š": "âš ï¸"
            }.get(activity["status"], "â„¹ï¸")

            st.markdown(f"""
            <div style="padding: 0.75rem; margin: 0.5rem 0; background: white; border-radius: 8px; border-left: 3px solid #667eea;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{activity['action']}</strong> {activity['target']}
                    </div>
                    <div>
                        {status_icon} {activity['status']}
                    </div>
                </div>
                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                    {activity['time']}
                </div>
            </div>
            """, unsafe_allow_html=True)

    with col2:
        st.markdown("### ğŸ“Š ç³»çµ±ç‹€æ…‹")

        system_status = [
            {"component": "æ•¸æ“šæœå‹™", "status": "æ­£å¸¸", "uptime": "99.9%"},
            {"component": "äº¤æ˜“å¼•æ“", "status": "æ­£å¸¸", "uptime": "99.8%"},
            {"component": "é¢¨æ§ç³»çµ±", "status": "æ­£å¸¸", "uptime": "100%"},
            {"component": "AIæ¨¡å‹", "status": "æ›´æ–°ä¸­", "uptime": "98.5%"},
            {"component": "ç›£æ§ç³»çµ±", "status": "æ­£å¸¸", "uptime": "99.7%"}
        ]

        for status in system_status:
            status_color = {
                "æ­£å¸¸": "#4CAF50",
                "è­¦å‘Š": "#FF9800",
                "éŒ¯èª¤": "#F44336",
                "æ›´æ–°ä¸­": "#2196F3",
                "ç¶­è­·ä¸­": "#9E9E9E"
            }.get(status["status"], "#666")

            st.markdown(f"""
            <div style="padding: 0.75rem; margin: 0.5rem 0; background: white; border-radius: 8px; border-left: 3px solid {status_color};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{status['component']}</strong>
                    </div>
                    <div style="color: {status_color};">
                        {status['status']}
                    </div>
                </div>
                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                    é‹è¡Œæ™‚é–“: {status['uptime']}
                </div>
            </div>
            """, unsafe_allow_html=True)

        # å¿«é€Ÿç³»çµ±æ“ä½œ
        st.markdown("### âš¡ å¿«é€Ÿæ“ä½œ")

        col_a, col_b = st.columns(2)

        with col_a:
            if st.button("ğŸ”„ åˆ·æ–°æ•¸æ“š", use_container_width=True):
                st.success("æ•¸æ“šå·²åˆ·æ–°")
                st.rerun()

        with col_b:
            if st.button("ğŸ“Š ç³»çµ±å ±å‘Š", use_container_width=True):
                st.session_state.current_view = "system_monitoring"
                st.rerun()

def load_page_module(module_name: str):
    """å‹•æ…‹è¼‰å…¥é é¢æ¨¡çµ„"""
    try:
        module_path = f"src.ui.pages.{module_name}"
        spec = importlib.util.find_spec(module_path)

        if spec is None:
            return None

        module = importlib.import_module(module_path)
        return module

    except Exception as e:
        logger.error(f"è¼‰å…¥æ¨¡çµ„ {module_name} å¤±æ•—: {e}")
        return None

def show_module_page(module_key: str):
    """é¡¯ç¤ºæ¨¡çµ„é é¢"""
    # é é¢æ¨™é¡Œå’Œå°èˆª
    col1, col2 = st.columns([1, 4])

    with col1:
        if st.button("ğŸ  è¿”å›ä¸»é ", type="secondary", use_container_width=True):
            st.session_state.current_view = "dashboard"
            if "quick_action" in st.session_state:
                del st.session_state.quick_action
            st.rerun()

    with col2:
        # éºµåŒ…å±‘å°èˆª
        st.markdown(f"**å°èˆªè·¯å¾‘:** ä¸»é  > {get_module_title(module_key)}")

    st.markdown("---")

    # è¼‰å…¥ä¸¦é¡¯ç¤ºæ¨¡çµ„
    module = load_page_module(module_key)

    if module and hasattr(module, 'show'):
        try:
            # é¡¯ç¤ºå¿«é€Ÿæ“ä½œæç¤º
            if "quick_action" in st.session_state:
                st.info(f"ğŸ’¡ æ‚¨é¸æ“‡äº†å¿«é€Ÿæ“ä½œï¼š{st.session_state.quick_action}")
                del st.session_state.quick_action

            # åŸ·è¡Œæ¨¡çµ„çš„ show å‡½æ•¸
            module.show()

        except Exception as e:
            logger.error(f"åŸ·è¡Œæ¨¡çµ„ {module_key} å¤±æ•—: {e}")
            show_module_fallback(module_key, str(e))
    else:
        show_module_fallback(module_key, "æ¨¡çµ„è¼‰å…¥å¤±æ•—")

def get_module_title(module_key: str) -> str:
    """ç²å–æ¨¡çµ„æ¨™é¡Œ"""
    modules_config = get_function_modules()

    for category in modules_config.values():
        for module in category['modules']:
            if module['key'] == module_key:
                return module['title']

    return module_key.replace('_', ' ').title()

def show_module_fallback(module_key: str, error_msg: str = ""):
    """é¡¯ç¤ºæ¨¡çµ„è¼‰å…¥å¤±æ•—çš„å‚™ç”¨å…§å®¹"""
    module_title = get_module_title(module_key)

    st.error(f"âŒ ç„¡æ³•è¼‰å…¥ {module_title} æ¨¡çµ„")

    if error_msg:
        with st.expander("éŒ¯èª¤è©³æƒ…"):
            st.code(error_msg)

    st.markdown(f"""
    ### ğŸ“‹ {module_title} åŠŸèƒ½èªªæ˜

    æ­¤æ¨¡çµ„æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š
    """)

    # æ ¹æ“šæ¨¡çµ„é¡å‹é¡¯ç¤ºä¸åŒçš„å‚™ç”¨å…§å®¹
    if module_key == "strategy_management":
        st.markdown("""
        - ğŸ“ å‰µå»ºå’Œç·¨è¼¯äº¤æ˜“ç­–ç•¥
        - ğŸ“Š ç­–ç•¥ç¸¾æ•ˆåˆ†æ
        - ğŸ”§ åƒæ•¸å„ªåŒ–
        - ğŸ“‹ ç­–ç•¥ç‰ˆæœ¬ç®¡ç†
        """)

        st.info("ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥åœ¨ç­–ç•¥ç®¡ç†ä¸­å‰µå»ºè‡ªå®šç¾©äº¤æ˜“ç­–ç•¥ï¼Œä¸¦é€šéå›æ¸¬é©—è­‰å…¶æ•ˆæœã€‚")

    elif module_key == "backtest":
        st.markdown("""
        - ğŸ“ˆ æ­·å²æ•¸æ“šå›æ¸¬
        - ğŸ“Š ç¸¾æ•ˆæŒ‡æ¨™åˆ†æ
        - ğŸ¯ åƒæ•¸æ•æ„Ÿæ€§åˆ†æ
        - ğŸ“‹ å›æ¸¬å ±å‘Šç”Ÿæˆ
        """)

        st.info("ğŸ’¡ æç¤ºï¼šå›æ¸¬å¯ä»¥å¹«åŠ©æ‚¨è©•ä¼°ç­–ç•¥åœ¨æ­·å²æ•¸æ“šä¸Šçš„è¡¨ç¾ã€‚")

    elif module_key == "portfolio_management":
        st.markdown("""
        - ğŸ’¼ æŠ•è³‡çµ„åˆæ§‹å»º
        - âš–ï¸ è³‡ç”¢é…ç½®å„ªåŒ–
        - ğŸ“Š é¢¨éšªæ”¶ç›Šåˆ†æ
        - ğŸ”„ å†å¹³è¡¡ç­–ç•¥
        """)

        st.info("ğŸ’¡ æç¤ºï¼šè‰¯å¥½çš„æŠ•è³‡çµ„åˆç®¡ç†æ˜¯æˆåŠŸæŠ•è³‡çš„é—œéµã€‚")

    elif module_key == "risk_management":
        st.markdown("""
        - âš ï¸ å¯¦æ™‚é¢¨éšªç›£æ§
        - ğŸš¨ é¢¨éšªè­¦å ±è¨­ç½®
        - ğŸ“Š é¢¨éšªæŒ‡æ¨™è¨ˆç®—
        - ğŸ›¡ï¸ é¢¨éšªæ§åˆ¶æªæ–½
        """)

        st.warning("âš ï¸ é‡è¦ï¼šé¢¨éšªç®¡ç†æ˜¯æŠ•è³‡ä¸­æœ€é‡è¦çš„ç’°ç¯€ï¼Œè«‹å‹™å¿…é‡è¦–ã€‚")

    else:
        st.markdown(f"""
        - ğŸ”§ {module_title} æ ¸å¿ƒåŠŸèƒ½
        - ğŸ“Š æ•¸æ“šåˆ†æå’Œè™•ç†
        - ğŸ“‹ çµæœå±•ç¤ºå’Œå ±å‘Š
        - âš™ï¸ åƒæ•¸é…ç½®å’Œå„ªåŒ–
        """)

    # ç›¸é—œåŠŸèƒ½æ¨è–¦
    st.markdown("### ğŸ”— ç›¸é—œåŠŸèƒ½æ¨è–¦")

    col1, col2, col3 = st.columns(3)

    with col1:
        if st.button("ğŸ“Š æŸ¥çœ‹å„€è¡¨æ¿", use_container_width=True):
            st.session_state.current_view = "dashboard"
            st.rerun()

    with col2:
        if st.button("ğŸ“ æ–°æ‰‹æŒ‡å—", use_container_width=True):
            st.session_state.current_view = "beginner_hub"
            st.rerun()

    with col3:
        if st.button("ğŸ“‹ ç³»çµ±å ±å‘Š", use_container_width=True):
            st.session_state.current_view = "reports"
            st.rerun()

def setup_auto_refresh():
    """è¨­ç½®è‡ªå‹•åˆ·æ–°åŠŸèƒ½"""
    # å´é‚Šæ¬„è¨­ç½®
    with st.sidebar:
        st.markdown("### âš™ï¸ ç³»çµ±è¨­ç½®")

        # è‡ªå‹•åˆ·æ–°è¨­ç½®
        auto_refresh = st.checkbox("è‡ªå‹•åˆ·æ–°æ•¸æ“š", value=True, key="auto_refresh")

        if auto_refresh:
            refresh_interval = st.slider(
                "åˆ·æ–°é–“éš” (ç§’)",
                min_value=5,
                max_value=60,
                value=30,
                step=5,
                key="refresh_interval"
            )

            # é¡¯ç¤ºä¸‹æ¬¡åˆ·æ–°æ™‚é–“
            if "last_refresh" not in st.session_state:
                st.session_state.last_refresh = datetime.now()

            next_refresh = st.session_state.last_refresh + timedelta(seconds=refresh_interval)
            time_until_refresh = (next_refresh - datetime.now()).total_seconds()

            if time_until_refresh <= 0:
                st.session_state.last_refresh = datetime.now()
                st.rerun()
            else:
                st.info(f"ä¸‹æ¬¡åˆ·æ–°: {int(time_until_refresh)}ç§’å¾Œ")

        # é¡¯ç¤ºè¨­ç½®
        st.markdown("### ğŸ¨ é¡¯ç¤ºè¨­ç½®")

        # ä¸»é¡Œè¨­ç½®
        theme = st.selectbox(
            "é¸æ“‡ä¸»é¡Œ",
            ["è‡ªå‹•", "æ·ºè‰²", "æ·±è‰²"],
            index=0,
            key="theme_setting"
        )

        # ä½ˆå±€è¨­ç½®
        layout_mode = st.selectbox(
            "ä½ˆå±€æ¨¡å¼",
            ["æ¨™æº–", "ç·Šæ¹Š", "å¯¬é¬†"],
            index=0,
            key="layout_mode"
        )

        # æ–°æ‰‹æ¨¡å¼
        beginner_mode = st.checkbox(
            "æ–°æ‰‹æ¨¡å¼",
            value=st.session_state.get("show_beginner_guide", True),
            key="beginner_mode"
        )

        if beginner_mode != st.session_state.get("show_beginner_guide", True):
            st.session_state.show_beginner_guide = beginner_mode

        # ç³»çµ±ä¿¡æ¯
        st.markdown("### ğŸ“Š ç³»çµ±ä¿¡æ¯")
        st.info(f"ç•¶å‰æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        st.info(f"ç•¶å‰é é¢: {st.session_state.get('current_view', 'dashboard')}")

        # å¿«é€Ÿå°èˆª
        st.markdown("### ğŸš€ å¿«é€Ÿå°èˆª")

        quick_nav_options = [
            ("ğŸ  ä¸»é ", "dashboard"),
            ("ğŸ¯ ç­–ç•¥ç®¡ç†", "strategy_management"),
            ("ğŸ“Š å›æ¸¬åˆ†æ", "backtest"),
            ("ğŸ’¼ æŠ•è³‡çµ„åˆ", "portfolio_management"),
            ("âš ï¸ é¢¨éšªæ§åˆ¶", "risk_management"),
            ("ğŸ¤– AI æ¨¡å‹", "ai_models"),
            ("ğŸ“ˆ ç³»çµ±ç›£æ§", "system_monitoring")
        ]

        for label, view_key in quick_nav_options:
            if st.button(label, key=f"quick_nav_{view_key}", use_container_width=True):
                st.session_state.current_view = view_key
                st.rerun()

def main():
    """ä¸»å‡½æ•¸"""
    try:
        # è¨­å®šé é¢é…ç½®
        setup_page_config()

        # æ‡‰ç”¨è‡ªå®šç¾©æ¨£å¼
        apply_custom_css()

        # åˆå§‹åŒ– session state
        if "current_view" not in st.session_state:
            st.session_state.current_view = "dashboard"

        # è¨­ç½®è‡ªå‹•åˆ·æ–°å’Œå´é‚Šæ¬„
        setup_auto_refresh()

        # é¡¯ç¤ºæ­¡è¿æ¨™é¡Œ
        show_welcome_header()

        # é¡¯ç¤ºæ–°æ‰‹å¼•å°
        if st.session_state.get("beginner_mode", True):
            show_beginner_guide()

        # ä¸»è¦å…§å®¹å€åŸŸ
        if st.session_state.current_view == "dashboard":
            # é¡¯ç¤ºæŠ•è³‡çµ„åˆæ¦‚è¦½
            show_portfolio_overview()

            # é¡¯ç¤ºå¿«é€Ÿæ“ä½œ
            show_quick_actions()

            # é¡¯ç¤ºå¸‚å ´æ¦‚æ³
            show_market_overview()

            # é¡¯ç¤ºåŠŸèƒ½æ¨¡çµ„
            show_function_modules()

            # é¡¯ç¤ºæœ€è¿‘æ´»å‹•
            show_recent_activities()

            # é è…³ä¿¡æ¯
            st.markdown("---")
            st.markdown("""
            <div style="text-align: center; color: #666; padding: 2rem;">
                <p>ğŸš€ AIæ™ºèƒ½äº¤æ˜“å¹³å° v3.0 | å°ˆç‚ºé‡åŒ–äº¤æ˜“è€Œè¨­è¨ˆ</p>
                <p>ğŸ’¡ æç¤ºï¼šä½¿ç”¨å´é‚Šæ¬„å¿«é€Ÿå°èˆªåˆ°ä¸åŒåŠŸèƒ½æ¨¡çµ„</p>
            </div>
            """, unsafe_allow_html=True)

        else:
            # é¡¯ç¤ºå…¶ä»–é é¢
            show_module_page(st.session_state.current_view)

    except Exception as e:
        logger.error(f"Web UI åŸ·è¡Œå¤±æ•—: {e}")
        st.error(f"âŒ ç³»çµ±éŒ¯èª¤: {e}")
        st.info("è«‹é‡æ–°æ•´ç†é é¢æˆ–è¯ç¹«æŠ€è¡“æ”¯æ´")

        # éŒ¯èª¤æ¢å¾©é¸é …
        col1, col2, col3 = st.columns(3)

        with col1:
            if st.button("ğŸ  è¿”å›ä¸»é ", type="primary"):
                st.session_state.current_view = "dashboard"
                st.rerun()

        with col2:
            if st.button("ğŸ”„ é‡æ–°è¼‰å…¥", type="secondary"):
                st.rerun()

        with col3:
            if st.button("ğŸ§¹ æ¸…é™¤ç·©å­˜", type="secondary"):
                for key in list(st.session_state.keys()):
                    if key not in ["current_view"]:
                        del st.session_state[key]
                st.rerun()

if __name__ == "__main__":
    main()
