#!/usr/bin/env python3
"""
AIäº¤æ˜“ç³»çµ± - ç”Ÿç”¢ç‰ˆæœ¬ (v3.0 æ•´åˆç‰ˆ)

æ•´åˆäº† v3.0 ç¾ä»£åŒ–è¨­è¨ˆèˆ‡ v2.2 ç©©å®šç‰¹æ€§çš„çµ±ä¸€ç‰ˆæœ¬ï¼š
- ğŸ¨ ç¾ä»£åŒ–å„€è¡¨æ¿è¨­è¨ˆ (ä¾†è‡ª v3.0)
- ğŸ“Š å³æ™‚æ•¸æ“šå±•ç¤ºå’Œæ–°æ‰‹å¼•å° (ä¾†è‡ª v3.0)
- âœ… ç©©å®šçš„éŒ¯èª¤è™•ç†å’Œæ¨¡çµ„è¼‰å…¥ (ä¾†è‡ª v2.2)
- ğŸ”§ ç¶“éé©—è­‰çš„æ€§èƒ½å„ªåŒ– (ä¾†è‡ª v2.2)
- ğŸš€ å®Œæ•´åŠŸèƒ½æ”¯æ´å’Œå‘å¾Œå…¼å®¹ (æ•´åˆç‰ˆ)

ç‰ˆæœ¬: v3.0 Production (æ•´åˆç‰ˆ)
ç‹€æ…‹: ğŸ¯ ç”Ÿç”¢å°±ç·’ - æœ€ä½³ç”¨æˆ¶é«”é©— + æœ€é«˜ç©©å®šæ€§
æœ€å¾Œæ›´æ–°: 2025-01-16

ä½¿ç”¨æ–¹å¼:
    python -m streamlit run src/ui/web_ui_production.py --server.address=127.0.0.1 --server.port=8501
"""

import os
import sys
import logging
import importlib.util
from typing import Dict, Any, Optional, List
from datetime import datetime, timedelta

# æ·»åŠ å°ˆæ¡ˆæ ¹ç›®éŒ„åˆ°Pythonè·¯å¾‘
project_root = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, project_root)
sys.path.insert(0, os.path.join(project_root, 'src'))

import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
import numpy as np

# è¨­å®šæ—¥èªŒ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# å°å…¥å¾Œç«¯æ•´åˆæœå‹™
try:
    from .backend_integration import (
        get_backend_service,
        show_service_status,
        execute_with_feedback,
        safe_service_call,
        update_market_data,
        run_backtest,
        get_portfolio_performance,
        get_risk_metrics,
        get_system_health,
        with_progress_indicator,
        with_error_handling
    )
    BACKEND_AVAILABLE = True
except ImportError as e:
    logger.warning(f"å¾Œç«¯æ•´åˆæœå‹™ä¸å¯ç”¨: {e}")
    BACKEND_AVAILABLE = False

# å°å…¥å¢å¼·éŒ¯èª¤è™•ç†
try:
    from .utils.enhanced_error_handler import (
        enhanced_error_handler,
        handle_error_with_ui,
        show_error_with_solutions
    )
    ENHANCED_ERROR_HANDLER_AVAILABLE = True
except ImportError as e:
    logger.warning(f"å¢å¼·éŒ¯èª¤è™•ç†ä¸å¯ç”¨: {e}")
    ENHANCED_ERROR_HANDLER_AVAILABLE = False

def setup_page_config():
    """è¨­å®šé é¢é…ç½® (æ•´åˆç‰ˆï¼šæ”¯æ´ç¾ä»£åŒ–è¨­è¨ˆå’Œå‚³çµ±å°èˆª)"""
    st.set_page_config(
        page_title="AI Trading System - æ™ºèƒ½äº¤æ˜“å¹³å°",
        page_icon="ğŸš€",
        layout="wide",
        initial_sidebar_state="auto"  # è‡ªå‹•èª¿æ•´å´é‚Šæ¬„ç‹€æ…‹
    )

def apply_custom_css():
    """æ‡‰ç”¨è‡ªå®šç¾© CSS æ¨£å¼ (å„ªåŒ–å¯è®€æ€§ç‰ˆæœ¬)"""
    st.markdown("""
    <style>
    /* ä¸»è¦å®¹å™¨æ¨£å¼ - å„ªåŒ–å°æ¯”åº¦ */
    .main-container {
        padding: 2rem;
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        position: relative;
    }

    /* æ·»åŠ åŠé€æ˜è¦†è“‹å±¤æå‡å¯è®€æ€§ */
    .main-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.1);
        border-radius: 12px;
        pointer-events: none;
    }

    /* ä¸»æ¨™é¡Œæ–‡å­—æ¨£å¼ - å¢å¼·å°æ¯”åº¦ */
    .main-title {
        color: #ffffff !important;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        font-weight: 700;
        margin: 0;
        font-size: 2.5rem;
        position: relative;
        z-index: 1;
    }

    .main-subtitle {
        color: #e2e8f0 !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        margin: 0.5rem 0 0 0;
        font-size: 1.1rem;
        position: relative;
        z-index: 1;
    }

    /* å¡ç‰‡æ¨£å¼ - æ·±è‰²ä¸»é¡Œè¨­è¨ˆ */
    .metric-card {
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
        border: 1px solid #4a5568;
    }

    /* å¡ç‰‡æ¨™é¡Œæ¨£å¼ - ç™½è‰²æ–‡å­— */
    .metric-card-title {
        color: #ffffff !important;
        font-weight: 600;
        font-size: 0.95rem;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    /* å¡ç‰‡æ•¸å€¼æ¨£å¼ - ç™½è‰²æ–‡å­—é«˜å°æ¯”åº¦ */
    .metric-value-success {
        color: #ffffff !important;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .metric-value-info {
        color: #ffffff !important;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .metric-value-warning {
        color: #ffffff !important;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .metric-value-neutral {
        color: #ffffff !important;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    /* åŠŸèƒ½æ¨¡çµ„å¡ç‰‡ */
    .function-card {
        background: #ffffff;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin: 0.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
        border: 1px solid #e2e8f0;
    }

    .function-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        border-color: #4a5568;
    }

    /* ç‹€æ…‹æŒ‡ç¤ºå™¨ - é©é…æ·±è‰²å¡ç‰‡èƒŒæ™¯ */
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 10px;
        border: 2px solid #ffffff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .status-active {
        background-color: #48bb78;  /* äº®ç¶ è‰²ï¼Œåœ¨æ·±è‰²èƒŒæ™¯ä¸Šæ¸…æ™°å¯è¦‹ */
        border-color: #ffffff;
    }
    .status-warning {
        background-color: #ed8936;  /* äº®æ©™è‰²ï¼Œåœ¨æ·±è‰²èƒŒæ™¯ä¸Šæ¸…æ™°å¯è¦‹ */
        border-color: #ffffff;
    }
    .status-error {
        background-color: #fc8181;  /* æ›´äº®çš„ç´…è‰²ï¼Œæé«˜å°æ¯”åº¦ */
        border-color: #ffffff;
    }
    .status-inactive {
        background-color: #a0aec0;  /* äº®ç°è‰²ï¼Œåœ¨æ·±è‰²èƒŒæ™¯ä¸Šæ¸…æ™°å¯è¦‹ */
        border-color: #ffffff;
    }

    /* æ–°æ‰‹æç¤º - æ·±è‰²ä¸»é¡Œè¨­è¨ˆ */
    .beginner-tip {
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        border: 1px solid #4a5568;
        border-left: 4px solid #667eea;
        padding: 1.5rem;
        margin: 1.5rem 0;
        border-radius: 0 8px 8px 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .beginner-tip h4 {
        color: #ffffff !important;
        margin-top: 0;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .beginner-tip p, .beginner-tip li {
        color: #e2e8f0 !important;
        line-height: 1.6;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .beginner-tip strong {
        color: #ffffff !important;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
        .main-container {
            padding: 1.5rem;
        }

        .main-title {
            font-size: 2rem;
        }

        .main-subtitle {
            font-size: 1rem;
        }

        .metric-card {
            padding: 1rem;
        }

        .function-card {
            margin: 0.25rem;
            padding: 0.75rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
        }
    }

    /* é«˜å°æ¯”åº¦æ¨¡å¼æ”¯æ´ */
    @media (prefers-contrast: high) {
        .main-container {
            background: #000000;
            border: 2px solid #ffffff;
        }

        .main-title, .main-subtitle {
            color: #ffffff !important;
            text-shadow: none;
        }

        .metric-card {
            background: #ffffff;
            border: 2px solid #000000;
        }

        .beginner-tip {
            background: #ffffff;
            border: 2px solid #000000;
        }
    }
    </style>
    """, unsafe_allow_html=True)

def get_available_pages() -> Dict[str, Dict[str, Any]]:
    """ç²å–å¯ç”¨çš„é é¢é…ç½® (æ•´åˆç‰ˆï¼šv2.2 ç©©å®šé…ç½® + v3.0 åŠŸèƒ½åˆ†é¡)"""
    return {
        # âœ… æ ¸å¿ƒåŠŸèƒ½é é¢ (å·²é©—è­‰ç©©å®š)
        "data_management": {
            "title": "ğŸ“ˆ æ•¸æ“šç®¡ç†",
            "module": "data_management",
            "description": "æ•¸æ“šè¼‰å…¥ã€æ¸…ç†å’Œç®¡ç†",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "core"
        },
        "feature_engineering": {
            "title": "ğŸ”§ ç‰¹å¾µå·¥ç¨‹",
            "module": "feature_engineering",
            "description": "æŠ€è¡“æŒ‡æ¨™å’Œç‰¹å¾µè¨ˆç®—",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "core"
        },
        "strategy_management": {
            "title": "ğŸ¯ ç­–ç•¥ç®¡ç†",
            "module": "strategy_management",
            "description": "äº¤æ˜“ç­–ç•¥é–‹ç™¼å’Œç®¡ç†",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "core"
        },
        "ai_models": {
            "title": "ğŸ¤– AI æ¨¡å‹",
            "module": "ai_models",
            "description": "æ©Ÿå™¨å­¸ç¿’æ¨¡å‹è¨“ç·´",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "advanced"
        },
        "backtest": {
            "title": "ğŸ“‰ å›æ¸¬åˆ†æ",
            "module": "backtest_enhanced",
            "description": "ç­–ç•¥å›æ¸¬å’Œç¸¾æ•ˆåˆ†æ (æ•´åˆç‰ˆï¼šåŒ…å«åƒæ•¸è¨­å®šã€åŸ·è¡Œæ§åˆ¶ã€æ•æ„Ÿæ€§åˆ†æ)",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "core"
        },
        "portfolio_management": {
            "title": "ğŸ’¼ æŠ•è³‡çµ„åˆ",
            "module": "portfolio_management",
            "description": "æŠ•è³‡çµ„åˆå„ªåŒ–å’Œç®¡ç† (æ•´åˆç‰ˆï¼šåŒ…å«é¢¨éšªåˆ†æã€é…ç½®å„ªåŒ–ã€ç¸¾æ•ˆæ­¸å› ã€å†å¹³è¡¡)",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "core"
        },
        "risk_management": {
            "title": "âš ï¸ é¢¨éšªæ§åˆ¶",
            "module": "risk_management",
            "description": "é¢¨éšªç®¡ç†å’Œæ§åˆ¶ (æ•´åˆç‰ˆï¼šåŒ…å«åƒæ•¸è¨­ç½®ã€ç›£æ§ã€è­¦å ±ã€éŸ¿æ‡‰å¼è¨­è¨ˆ)",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "core"
        },
        "trade_execution": {
            "title": "ğŸš€ äº¤æ˜“åŸ·è¡Œ",
            "module": "trade_execution",
            "description": "å¯¦æ™‚äº¤æ˜“åŸ·è¡Œ",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "advanced"
        },
        "system_monitoring": {
            "title": "ğŸ“Š ç³»çµ±ç›£æ§",
            "module": "system_monitoring",
            "description": "ç³»çµ±æ€§èƒ½ç›£æ§ (æ•´åˆç‰ˆï¼šåŒ…å«å¢å¼·ç›£æ§å„€è¡¨æ¿ã€æ™ºèƒ½è­¦å ±)",
            "status": "âœ… å®Œæ•´åŠŸèƒ½"
        },
        "system_status_enhanced": {
            "title": "ğŸ” ç³»çµ±ç‹€æ…‹æª¢æŸ¥",
            "module": "system_status_enhanced",
            "description": "å¢å¼·ç‰ˆç³»çµ±ç‹€æ…‹ç›£æ§ - å¯¦æ™‚æ¨¡çµ„ç‹€æ…‹ã€å¥åº·åº¦è©•ä¼°ã€ä¾è³´æª¢æŸ¥",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "core"
        },
        "ai_model_management": {
            "title": "ğŸ¤– AIæ¨¡å‹ç®¡ç†",
            "module": "ai_model_management",
            "description": "AIæ¨¡å‹å‰µå»ºã€è¨“ç·´ã€é æ¸¬å’Œç®¡ç† - æ”¯æŒå¤šç¨®æ©Ÿå™¨å­¸ç¿’æ¨¡å‹",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "ai"
        },
        "beginner_tutorial": {
            "title": "ğŸ“ æ–°æ‰‹å¼•å°æ•™ç¨‹",
            "module": "beginner_tutorial",
            "description": "5åˆ†é˜äº’å‹•å¼å…¥é–€æ•™ç¨‹ - å¿«é€Ÿä¸Šæ‰‹AIäº¤æ˜“ç³»çµ±",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "tutorial"
        },
        "data_source_config_wizard": {
            "title": "âš™ï¸ æ•¸æ“šæºé…ç½®å‘å°",
            "module": "data_source_config_wizard",
            "description": "ç°¡åŒ–æ•¸æ“šæºé…ç½®æµç¨‹ - Tushareã€Windã€BaoStockä¸€éµé…ç½®",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "config"
        },
        "function_status_dashboard": {
            "title": "ğŸ›ï¸ åŠŸèƒ½ç‹€æ…‹å„€è¡¨æ¿",
            "module": "function_status_dashboard",
            "description": "å¯¦æ™‚åŠŸèƒ½ç‹€æ…‹ç›£æ§ - å¥åº·åº¦æŒ‡æ¨™ã€å•é¡Œè¨ºæ–·ã€ä¿®å¾©å»ºè­°",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "monitoring"
        },
        "modern_dashboard_enhanced": {
            "title": "ğŸš€ ç¾ä»£åŒ–å„€è¡¨æ¿",
            "module": "modern_dashboard_enhanced",
            "description": "ç¾ä»£åŒ–éŸ¿æ‡‰å¼å„€è¡¨æ¿ - æ·±è‰²ä¸»é¡Œã€è‡ªå®šç¾©ä½ˆå±€ã€æ™ºèƒ½æ´å¯Ÿ",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "dashboard"
        },
        "intelligent_recommendations": {
            "title": "ğŸ§  æ™ºèƒ½æ¨è–¦ç³»çµ±",
            "module": "intelligent_recommendations",
            "description": "AIé©…å‹•çš„å€‹æ€§åŒ–æ¨è–¦ - ç­–ç•¥å»ºè­°ã€é¢¨éšªæé†’ã€æŠ•è³‡æ©Ÿæœƒ",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "ai"
        },
        "advanced_monitoring": {
            "title": "ğŸ” é«˜ç´šç›£æ§ç³»çµ±",
            "module": "advanced_monitoring",
            "description": "å…¨é¢ç›£æ§ç³»çµ± - è©³ç´°æ—¥èªŒã€æ€§èƒ½ç›£æ§ã€ç•°å¸¸è¿½è¹¤",
            "status": "âœ… å®Œæ•´åŠŸèƒ½",
            "category": "monitoring"
        },
        "reports": {
            "title": "ğŸ“‹ å ±å‘Šåˆ†æ",
            "module": "reports",
            "description": "äº¤æ˜“å ±å‘Šå’Œåˆ†æ (æ•´åˆç‰ˆï¼šåŒ…å«å‹•æ…‹æŸ¥è©¢ã€åœ–è¡¨ç”Ÿæˆã€å¤šæ ¼å¼åŒ¯å‡º)",
            "status": "âœ… å®Œæ•´åŠŸèƒ½"
        },
        "text_analysis": {
            "title": "ğŸ“ æ–‡æœ¬åˆ†æ",
            "module": "text_analysis",
            "description": "æ–°èæƒ…æ„Ÿåˆ†æå’Œæ–‡æœ¬è™•ç†",
            "status": "âœ… å®Œæ•´åŠŸèƒ½"
        },
        "rl_strategy_management": {
            "title": "ğŸ¤– å¼·åŒ–å­¸ç¿’ç­–ç•¥",
            "module": "rl_strategy_management",
            "description": "å¼·åŒ–å­¸ç¿’ç­–ç•¥ç®¡ç†",
            "status": "âœ… å®Œæ•´åŠŸèƒ½"
        },
        "security_management": {
            "title": "ğŸ”’ å®‰å…¨ç®¡ç†",
            "module": "security_management",
            "description": "ç³»çµ±å®‰å…¨å’Œæ¬Šé™ç®¡ç†",
            "status": "âœ… å®Œæ•´åŠŸèƒ½"
        },
        "two_factor_management": {
            "title": "ğŸ” å¤šé‡èº«ä»½é©—è­‰",
            "module": "two_factor_management",
            "description": "é›™å› å­èªè­‰ç®¡ç†",
            "status": "âœ… å®Œæ•´åŠŸèƒ½"
        },

        # âš ï¸ éƒ¨åˆ†åŠŸèƒ½é é¢ (å¯ç”¨ä½†åŠŸèƒ½ä¸å®Œæ•´)
        "dashboard": {
            "title": "ğŸ“Š ç³»çµ±å„€è¡¨æ¿",
            "module": "realtime_dashboard",
            "description": "ç³»çµ±ç¸½è¦½å’Œå³æ™‚ç›£æ§",
            "status": "âš ï¸ éƒ¨åˆ†åŠŸèƒ½"
        },
        "beginner_hub": {
            "title": "ğŸ“ æ–°æ‰‹ä¸­å¿ƒ",
            "module": "beginner_hub",
            "description": "æ–°æ‰‹å¼•å°å’Œå­¸ç¿’ä¸­å¿ƒ",
            "status": "âœ… å®Œæ•´åŠŸèƒ½"
        },
        "custom_dashboard": {
            "title": "ğŸ¨ è‡ªå®šç¾©å„€è¡¨æ¿",
            "module": "custom_dashboard",
            "description": "æ‹–æ‹½å¼å„€è¡¨æ¿å‰µå»ºå’Œç·¨è¼¯",
            "status": "âœ… å®Œæ•´åŠŸèƒ½"
        },
        "interactive_charts": {
            "title": "ğŸ“Š äº’å‹•å¼åœ–è¡¨",
            "module": "interactive_charts",
            "description": "é«˜åº¦äº’å‹•çš„åœ–è¡¨åˆ†æå·¥å…·",
            "status": "âœ… å®Œæ•´åŠŸèƒ½"
        },
        "market_watch": {
            "title": "ğŸ“ˆ å¸‚å ´çœ‹ç›¤",
            "module": "market_watch",
            "description": "å¯¦æ™‚å¸‚å ´ç›£æ§å’Œçœ‹ç›¤å·¥å…·",
            "status": "âœ… å®Œæ•´åŠŸèƒ½"
        },
        "multi_agent_dashboard": {
            "title": "ğŸ¤– å¤šä»£ç†ç®¡ç†",
            "module": "multi_agent_dashboard",
            "description": "å¤šä»£ç†AIäº¤æ˜“ç³»çµ±ç®¡ç†",
            "status": "âœ… å®Œæ•´åŠŸèƒ½"
        }
    }

def show_welcome_header():
    """é¡¯ç¤ºæ­¡è¿æ¨™é¡Œå€åŸŸ (å„ªåŒ–å¯è®€æ€§ç‰ˆæœ¬)"""
    current_time = datetime.now()

    # ä¸»æ¨™é¡Œå€åŸŸ - ä½¿ç”¨å„ªåŒ–çš„æ¨£å¼é¡
    st.markdown("""
    <div class="main-container">
        <h1 class="main-title">
            ğŸš€ AIæ™ºèƒ½äº¤æ˜“å¹³å°
        </h1>
        <p class="main-subtitle">
            æ­¡è¿å›ä¾†ï¼è®“æˆ‘å€‘ä¸€èµ·æ¢ç´¢æ™ºèƒ½äº¤æ˜“çš„ä¸–ç•Œ
        </p>
    </div>
    """, unsafe_allow_html=True)

    # å¿«é€Ÿç‹€æ…‹æ¬„ - ä½¿ç”¨å„ªåŒ–çš„å°æ¯”åº¦
    col1, col2, col3, col4 = st.columns(4)

    with col1:
        st.markdown("""
        <div class="metric-card">
            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                <span class="status-indicator status-active"></span>
                <span class="metric-card-title">ç³»çµ±ç‹€æ…‹</span>
            </div>
            <div class="metric-value-success" style="font-size: 1.2rem; margin-top: 0.5rem;">
                âœ… é‹è¡Œæ­£å¸¸
            </div>
        </div>
        """, unsafe_allow_html=True)

    with col2:
        st.markdown(f"""
        <div class="metric-card">
            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                <span class="status-indicator status-active"></span>
                <span class="metric-card-title">å¸‚å ´ç‹€æ…‹</span>
            </div>
            <div class="metric-value-info" style="font-size: 1.2rem; margin-top: 0.5rem;">
                ğŸ“ˆ é–‹ç›¤ä¸­
            </div>
        </div>
        """, unsafe_allow_html=True)

    with col3:
        st.markdown("""
        <div class="metric-card">
            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                <span class="status-indicator status-warning"></span>
                <span class="metric-card-title">æ´»èºç­–ç•¥</span>
            </div>
            <div class="metric-value-warning" style="font-size: 1.2rem; margin-top: 0.5rem;">
                âš¡ 3 å€‹é‹è¡Œä¸­
            </div>
        </div>
        """, unsafe_allow_html=True)

    with col4:
        st.markdown(f"""
        <div class="metric-card">
            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                <span class="status-indicator status-active"></span>
                <span class="metric-card-title">ç•¶å‰æ™‚é–“</span>
            </div>
            <div class="metric-value-neutral" style="font-size: 1.2rem; margin-top: 0.5rem;">
                ğŸ• {current_time.strftime('%H:%M:%S')}
            </div>
        </div>
        """, unsafe_allow_html=True)

def show_portfolio_overview():
    """é¡¯ç¤ºæŠ•è³‡çµ„åˆæ¦‚è¦½ (æ•´åˆå¾Œç«¯æ•¸æ“š)"""
    st.markdown("## ğŸ’¼ æŠ•è³‡çµ„åˆæ¦‚è¦½")

    # å˜—è©¦ç²å–å¯¦éš›çš„æŠ•è³‡çµ„åˆæ•¸æ“š
    if BACKEND_AVAILABLE:
        portfolio_data = get_portfolio_performance()

        if portfolio_data:
            # ä½¿ç”¨å¯¦éš›æ•¸æ“š
            portfolio_value = portfolio_data.get("total_value", 1250000)
            daily_change = portfolio_data.get("daily_change", 15600)
            daily_change_pct = portfolio_data.get("daily_change_pct", 1.26)
            positions_count = portfolio_data.get("positions_count", 8)
            cash_balance = portfolio_data.get("cash_balance", 125000)
        else:
            # ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šä½œç‚ºå‚™ç”¨
            portfolio_value = 1250000
            daily_change = 15600
            daily_change_pct = 1.26
            positions_count = 8
            cash_balance = 125000
    else:
        # å¾Œç«¯ä¸å¯ç”¨æ™‚ä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
        portfolio_value = 1250000
        daily_change = 15600
        daily_change_pct = 1.26
        positions_count = 8
        cash_balance = 125000

    col1, col2, col3, col4 = st.columns(4)

    with col1:
        st.metric(
            label="ç¸½è³‡ç”¢åƒ¹å€¼",
            value=f"${portfolio_value:,}",
            delta=f"${daily_change:,}"
        )

    with col2:
        st.metric(
            label="ä»Šæ—¥æ”¶ç›Šç‡",
            value=f"{daily_change_pct:+.2f}%",
            delta=f"{daily_change_pct:+.2f}%"
        )

    with col3:
        st.metric(
            label="æŒå€‰æ•¸é‡",
            value=str(positions_count),
            delta="0"
        )

    with col4:
        st.metric(
            label="å¯ç”¨ç¾é‡‘",
            value=f"${cash_balance:,}",
            delta="-$5,000"
        )

    # æ·»åŠ åˆ·æ–°æŒ‰éˆ•
    if st.button("ğŸ”„ åˆ·æ–°æŠ•è³‡çµ„åˆæ•¸æ“š", key="refresh_portfolio"):
        if BACKEND_AVAILABLE:
            with st.spinner("æ­£åœ¨åˆ·æ–°æŠ•è³‡çµ„åˆæ•¸æ“š..."):
                portfolio_data = get_portfolio_performance()
                if portfolio_data:
                    st.success("æŠ•è³‡çµ„åˆæ•¸æ“šå·²æ›´æ–°")
                    st.rerun()
                else:
                    st.warning("ç„¡æ³•ç²å–æŠ•è³‡çµ„åˆæ•¸æ“š")
        else:
            st.warning("å¾Œç«¯æœå‹™ä¸å¯ç”¨ï¼Œç„¡æ³•åˆ·æ–°æ•¸æ“š")

def show_beginner_guide():
    """é¡¯ç¤ºæ–°æ‰‹å¼•å° (ä¾†è‡ª v3.0 è¨­è¨ˆ)"""
    if st.session_state.get("show_beginner_guide", True):
        st.markdown("""
        <div class="beginner-tip">
            <h4>ğŸ’¡ æ–°æ‰‹æç¤º</h4>
            <p>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½äº¤æ˜“å¹³å°ï¼é€™è£¡æ˜¯æ‚¨çš„å°ˆå±¬äº¤æ˜“åŠ©æ‰‹ã€‚</p>
            <ul>
                <li><strong>æŠ•è³‡çµ„åˆæ¦‚è¦½</strong>ï¼šæŸ¥çœ‹æ‚¨çš„è³‡ç”¢ç‹€æ³å’Œæ”¶ç›Šè¡¨ç¾</li>
                <li><strong>å¿«é€Ÿæ“ä½œ</strong>ï¼šä¸€éµè¨ªå•å¸¸ç”¨åŠŸèƒ½</li>
                <li><strong>åŠŸèƒ½æ¨¡çµ„</strong>ï¼šæ¢ç´¢æ›´å¤šé«˜ç´šåŠŸèƒ½</li>
            </ul>
        </div>
        """, unsafe_allow_html=True)

        if st.button("æˆ‘å·²äº†è§£ï¼Œä¸å†é¡¯ç¤º", key="hide_beginner_guide"):
            st.session_state.show_beginner_guide = False
            st.rerun()

def show_sidebar() -> Optional[str]:
    """é¡¯ç¤ºå´é‚Šæ¬„å°èˆª (ç°¡åŒ–ç‰ˆï¼šåƒ…ç¾ä»£åŒ–å„€è¡¨æ¿æ¨¡å¼)"""
    with st.sidebar:
        st.title("ğŸ§­ ç³»çµ±å°èˆª")

        # å›ºå®šç‚ºç¾ä»£åŒ–å„€è¡¨æ¿æ¨¡å¼
        st.session_state.view_mode = "ğŸ¨ ç¾ä»£åŒ–å„€è¡¨æ¿"

        st.markdown("---")

        # åˆå§‹åŒ– selected_page
        selected_page = "dashboard"

        # è¨­ç½®åŠŸèƒ½
        st.markdown("### âš™ï¸ ç³»çµ±è¨­ç½®")

        # è‡ªå‹•åˆ·æ–°è¨­ç½®
        auto_refresh = st.checkbox("è‡ªå‹•åˆ·æ–°æ•¸æ“š", value=True, key="auto_refresh")

        if auto_refresh:
            refresh_interval = st.slider(
                "åˆ·æ–°é–“éš” (ç§’)",
                min_value=5,
                max_value=60,
                value=30,
                step=5,
                key="refresh_interval"
            )

        # æ–°æ‰‹æ¨¡å¼
        beginner_mode = st.checkbox(
            "æ–°æ‰‹æ¨¡å¼",
            value=st.session_state.get("show_beginner_guide", True),
            key="beginner_mode"
        )

        if beginner_mode != st.session_state.get("show_beginner_guide", True):
            st.session_state.show_beginner_guide = beginner_mode

        st.markdown("---")

        # ç³»çµ±ç‹€æ…‹ (æ•´åˆç‰ˆ)
        st.markdown("### ğŸš¦ ç³»çµ±ç‹€æ…‹")
        if BACKEND_AVAILABLE:
            backend_service = get_backend_service()
            if backend_service.is_initialized:
                st.success("âœ… å¾Œç«¯æœå‹™æ­£å¸¸")
            else:
                st.error("âŒ å¾Œç«¯æœå‹™åˆå§‹åŒ–å¤±æ•—")
        else:
            st.warning("âš ï¸ å¾Œç«¯æœå‹™ä¸å¯ç”¨")

        # å¿«é€Ÿæ“ä½œ (æ•´åˆç‰ˆ)
        st.markdown("### âš¡ å¿«é€Ÿæ“ä½œ")
        if st.button("ğŸ”„ é‡æ–°è¼‰å…¥", use_container_width=True):
            st.rerun()

        if st.button("ğŸ“Š æ€§èƒ½ç›£æ§", use_container_width=True):
            st.session_state["show_performance"] = True

        if st.button("ğŸ” ç³»çµ±ç‹€æ…‹æª¢æŸ¥", use_container_width=True):
            st.session_state.current_view = "system_monitoring"
            st.rerun()

        # å¿«é€Ÿå°èˆª
        st.markdown("### ğŸš€ å¿«é€Ÿå°èˆª")

        quick_nav_options = [
            ("ğŸ¯ ç­–ç•¥ç®¡ç†", "strategy_management"),
            ("ğŸ“Š å›æ¸¬åˆ†æ", "backtest"),
            ("ğŸ’¼ æŠ•è³‡çµ„åˆ", "portfolio_management"),
            ("âš ï¸ é¢¨éšªæ§åˆ¶", "risk_management"),
            ("ğŸ¤– AI æ¨¡å‹", "ai_models"),
            ("ğŸ“ˆ ç³»çµ±ç›£æ§", "system_monitoring")
        ]

        for label, view_key in quick_nav_options:
            if st.button(label, key=f"quick_nav_{view_key}", use_container_width=True):
                st.session_state.current_view = view_key
                st.rerun()

        return selected_page

def load_page_module(page_key: str):
    """å‹•æ…‹è¼‰å…¥é é¢æ¨¡çµ„ (æ•´åˆç‰ˆï¼šv2.2 ç©©å®šéŒ¯èª¤è™•ç† + v3.0 å¢å¼·åŠŸèƒ½)"""
    try:
        pages = get_available_pages()
        page_config = pages.get(page_key, {})
        module_name = page_config.get("module", page_key)

        module_path = f"src.ui.pages.{module_name}"
        spec = importlib.util.find_spec(module_path)

        if spec is None:
            logger.warning(f"æ‰¾ä¸åˆ°æ¨¡çµ„: {module_path}")
            return None

        module = importlib.import_module(module_path)
        logger.info(f"æˆåŠŸè¼‰å…¥æ¨¡çµ„: {module_path}")
        return module

    except Exception as e:
        logger.error(f"è¼‰å…¥æ¨¡çµ„ {page_key} å¤±æ•—: {e}")
        return None

def show_system_status_overview():
    """é¡¯ç¤ºç³»çµ±ç‹€æ…‹æ¦‚è¦½"""
    st.markdown("## ğŸ” ç³»çµ±ç‹€æ…‹æ¦‚è¦½")

    try:
        from src.ui.components.feature_status import feature_status

        # å¿«é€Ÿæª¢æŸ¥æ ¸å¿ƒåŠŸèƒ½
        with st.spinner("æª¢æŸ¥ç³»çµ±ç‹€æ…‹..."):
            results = feature_status.check_all_features()

        # çµ±è¨ˆç‹€æ…‹
        healthy_count = sum(1 for r in results.values() if r["status"] == "healthy")
        warning_count = sum(1 for r in results.values() if r["status"] == "warning")
        error_count = sum(1 for r in results.values() if r["status"] == "error")
        total_count = len(results)

        # é¡¯ç¤ºç‹€æ…‹å¡ç‰‡
        col1, col2, col3, col4 = st.columns(4)

        with col1:
            st.metric(
                "âœ… æ­£å¸¸åŠŸèƒ½",
                healthy_count,
                f"{healthy_count/total_count*100:.0f}%",
                delta_color="normal"
            )

        with col2:
            st.metric(
                "âš ï¸ éƒ¨åˆ†å¯ç”¨",
                warning_count,
                f"{warning_count/total_count*100:.0f}%",
                delta_color="off" if warning_count == 0 else "inverse"
            )

        with col3:
            st.metric(
                "âŒ éœ€ä¿®å¾©",
                error_count,
                f"{error_count/total_count*100:.0f}%",
                delta_color="off" if error_count == 0 else "inverse"
            )

        with col4:
            overall_health = healthy_count / total_count * 100
            if overall_health >= 80:
                health_status = "å„ªç§€"
                health_color = "normal"
            elif overall_health >= 60:
                health_status = "è‰¯å¥½"
                health_color = "normal"
            else:
                health_status = "éœ€æ”¹é€²"
                health_color = "inverse"

            st.metric(
                "ğŸ¯ ç³»çµ±å¥åº·åº¦",
                f"{overall_health:.0f}%",
                health_status,
                delta_color=health_color
            )

        # é¡¯ç¤ºé—œéµå•é¡Œ
        if error_count > 0 or warning_count > 0:
            with st.expander("âš ï¸ éœ€è¦æ³¨æ„çš„å•é¡Œ", expanded=True):
                for feature_name, result in results.items():
                    if result["status"] in ["error", "warning"]:
                        status_icon = "âŒ" if result["status"] == "error" else "âš ï¸"
                        st.write(f"{status_icon} **{feature_name}**: {result['message']}")

        # å¿«é€Ÿæ“ä½œæŒ‰éˆ•
        col1, col2 = st.columns(2)
        with col1:
            if st.button("ğŸ“Š æŸ¥çœ‹è©³ç´°ç‹€æ…‹", use_container_width=True):
                st.session_state.current_view = "system_monitoring"
                st.rerun()

        with col2:
            if st.button("ğŸ“¦ å®‰è£ç¼ºå¤±ä¾è³´", use_container_width=True):
                st.info("ğŸ’¡ è«‹åœ¨çµ‚ç«¯é‹è¡Œ: `python install_dependencies.py`")

    except Exception as e:
        st.error(f"ç„¡æ³•è¼‰å…¥ç³»çµ±ç‹€æ…‹: {str(e)}")
        st.info("ç³»çµ±åŸºæœ¬åŠŸèƒ½ä»å¯æ­£å¸¸ä½¿ç”¨")


def show_dashboard_mode():
    """é¡¯ç¤ºç¾ä»£åŒ–å„€è¡¨æ¿æ¨¡å¼ (ä¾†è‡ª v3.0)"""
    # é¡¯ç¤ºæ­¡è¿æ¨™é¡Œ
    show_welcome_header()

    # é¡¯ç¤ºæ–°æ‰‹å¼•å°
    if st.session_state.get("beginner_mode", True):
        show_beginner_guide()

    # é¡¯ç¤ºæŠ•è³‡çµ„åˆæ¦‚è¦½
    show_portfolio_overview()

    # é¡¯ç¤ºç³»çµ±åŠŸèƒ½ç‹€æ…‹ (æ–°å¢)
    show_system_status_overview()

    # å¿«é€Ÿæ“ä½œå€åŸŸ
    st.markdown("## âš¡ å¿«é€Ÿæ“ä½œ")

    col1, col2, col3, col4 = st.columns(4)

    with col1:
        if st.button("ğŸ¯ æ–°å»ºç­–ç•¥", use_container_width=True, type="primary"):
            st.session_state.current_view = "strategy_management"
            st.rerun()

    with col2:
        if st.button("ğŸ“Š æŸ¥çœ‹å›æ¸¬", use_container_width=True):
            st.session_state.current_view = "backtest"
            st.rerun()

    with col3:
        if st.button("âš ï¸ é¢¨éšªç›£æ§", use_container_width=True):
            st.session_state.current_view = "risk_management"
            st.rerun()

    with col4:
        if st.button("ğŸ“ˆ å¸‚å ´åˆ†æ", use_container_width=True):
            st.session_state.current_view = "market_watch"
            st.rerun()

    # æ•¸æ“šæ›´æ–°æ“ä½œå€åŸŸ
    st.markdown("## ğŸ”„ æ•¸æ“šæ›´æ–°")

    col1, col2, col3, col4 = st.columns(4)

    with col1:
        if st.button("ğŸ“ˆ æ›´æ–°è‚¡åƒ¹æ•¸æ“š", use_container_width=True):
            if BACKEND_AVAILABLE:
                update_market_data(["price"])
            else:
                st.warning("å¾Œç«¯æœå‹™ä¸å¯ç”¨ï¼Œç„¡æ³•æ›´æ–°æ•¸æ“š")

    with col2:
        if st.button("ğŸ’° æ›´æ–°è²¡å‹™æ•¸æ“š", use_container_width=True):
            if BACKEND_AVAILABLE:
                update_market_data(["bargin", "pe"])
            else:
                st.warning("å¾Œç«¯æœå‹™ä¸å¯ç”¨ï¼Œç„¡æ³•æ›´æ–°æ•¸æ“š")

    with col3:
        if st.button("ğŸ”„ å…¨é‡æ•¸æ“šæ›´æ–°", use_container_width=True):
            if BACKEND_AVAILABLE:
                update_market_data(["price", "bargin", "pe"])
            else:
                st.warning("å¾Œç«¯æœå‹™ä¸å¯ç”¨ï¼Œç„¡æ³•æ›´æ–°æ•¸æ“š")

    with col4:
        if st.button("ğŸ“Š ç³»çµ±ç‹€æ…‹æª¢æŸ¥", use_container_width=True):
            if BACKEND_AVAILABLE:
                health_status = get_system_health()
                if health_status:
                    st.success("ç³»çµ±é‹è¡Œæ­£å¸¸")
                else:
                    st.warning("ç³»çµ±ç‹€æ…‹æª¢æŸ¥å¤±æ•—")
            else:
                st.warning("å¾Œç«¯æœå‹™ä¸å¯ç”¨ï¼Œç„¡æ³•æª¢æŸ¥ç³»çµ±ç‹€æ…‹")

    # åŠŸèƒ½æ¨¡çµ„å±•ç¤º
    st.markdown("## ğŸ”§ åŠŸèƒ½æ¨¡çµ„")

    pages = get_available_pages()

    # æŒ‰é¡åˆ¥åˆ†çµ„
    core_modules = {k: v for k, v in pages.items() if v.get("category") == "core" and v.get("status", "").startswith("âœ…")}
    advanced_modules = {k: v for k, v in pages.items() if v.get("category") == "advanced" and v.get("status", "").startswith("âœ…")}
    data_modules = {k: v for k, v in pages.items() if v.get("category") == "data" and v.get("status", "").startswith("âœ…")}

    # æ ¸å¿ƒåŠŸèƒ½
    if core_modules:
        st.markdown("### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½")
        cols = st.columns(min(len(core_modules), 4))

        for i, (key, config) in enumerate(core_modules.items()):
            with cols[i % 4]:
                if st.button(config["title"], key=f"core_{key}", use_container_width=True):
                    st.session_state.current_view = key
                    st.rerun()
                st.caption(config["description"])

    # é«˜ç´šåŠŸèƒ½
    if advanced_modules:
        st.markdown("### ğŸ¤– é«˜ç´šåŠŸèƒ½")
        cols = st.columns(min(len(advanced_modules), 4))

        for i, (key, config) in enumerate(advanced_modules.items()):
            with cols[i % 4]:
                if st.button(config["title"], key=f"advanced_{key}", use_container_width=True):
                    st.session_state.current_view = key
                    st.rerun()
                st.caption(config["description"])

    # æ•¸æ“šåŠŸèƒ½
    if data_modules:
        st.markdown("### ğŸ“Š æ•¸æ“šåŠŸèƒ½")
        cols = st.columns(min(len(data_modules), 4))

        for i, (key, config) in enumerate(data_modules.items()):
            with cols[i % 4]:
                if st.button(config["title"], key=f"data_{key}", use_container_width=True):
                    st.session_state.current_view = key
                    st.rerun()
                st.caption(config["description"])

def render_system_monitoring_page():
    """æ¸²æŸ“ç³»çµ±ç›£æ§é é¢"""
    # é¡¯ç¤ºé é¢æ¨™é¡Œå’Œå°èˆª
    col1, col2 = st.columns([1, 4])

    with col1:
        if st.button("ğŸ  è¿”å›ä¸»é ", type="secondary", use_container_width=True):
            st.session_state.current_view = "dashboard"
            st.rerun()

    with col2:
        st.markdown("**å°èˆªè·¯å¾‘:** ä¸»é  > ç³»çµ±ç›£æ§")

    st.markdown("---")

    # é¡¯ç¤ºç³»çµ±ç›£æ§å…§å®¹
    try:
        from src.ui.components.feature_status import show_feature_status
        show_feature_status()
    except Exception as e:
        st.error(f"ç„¡æ³•è¼‰å…¥ç³»çµ±ç›£æ§åŠŸèƒ½: {str(e)}")
        st.info("è«‹æª¢æŸ¥ç³»çµ±å®‰è£æ˜¯å¦å®Œæ•´")


def render_page(page_key: str):
    """æ¸²æŸ“æŒ‡å®šé é¢ (æ•´åˆç‰ˆï¼šv2.2 ç©©å®šéŒ¯èª¤è™•ç† + v3.0 å¢å¼·é«”é©—)"""
    # ç‰¹æ®Šé é¢è™•ç†
    if page_key == "system_monitoring":
        render_system_monitoring_page()
        return

    pages = get_available_pages()

    if page_key not in pages:
        st.error(f"âŒ æœªçŸ¥é é¢: {page_key}")
        return

    page_config = pages[page_key]

    # é¡¯ç¤ºé é¢æ¨™é¡Œå’Œå°èˆª (ä¾†è‡ª v3.0)
    col1, col2 = st.columns([1, 4])

    with col1:
        if st.button("ğŸ  è¿”å›ä¸»é ", type="secondary", use_container_width=True):
            st.session_state.current_view = "dashboard"
            st.rerun()

    with col2:
        st.markdown(f"**å°èˆªè·¯å¾‘:** ä¸»é  > {page_config['title']}")

    st.markdown("---")

    # é¡¯ç¤ºé é¢æ¨™é¡Œ
    st.title(page_config["title"])

    # å˜—è©¦è¼‰å…¥ä¸¦åŸ·è¡Œé é¢æ¨¡çµ„ (v2.2 ç©©å®šé‚è¼¯)
    module = load_page_module(page_key)

    if module and hasattr(module, 'show'):
        try:
            # é¡¯ç¤ºé é¢ç‹€æ…‹
            status = page_config.get("status", "æœªçŸ¥")
            if status.startswith("âœ…"):
                st.success(f"âœ… æ­¤åŠŸèƒ½å·²å®Œæ•´å¯¦ç¾ä¸¦å¯æ­£å¸¸ä½¿ç”¨")
            elif status.startswith("âš ï¸"):
                st.warning(f"âš ï¸ æ­¤åŠŸèƒ½éƒ¨åˆ†å¯ç”¨ï¼Œå¯èƒ½æœ‰äº›é™åˆ¶")

            # åŸ·è¡Œé é¢æ¨¡çµ„
            with st.container():
                module.show()

        except Exception as e:
            st.error(f"âŒ é é¢åŸ·è¡Œå¤±æ•—: {e}")
            logger.error(f"é é¢ {page_key} åŸ·è¡Œå¤±æ•—: {e}")

            # é¡¯ç¤ºéŒ¯èª¤è©³æƒ… (v2.2 ç©©å®šåŠŸèƒ½)
            with st.expander("ğŸ”§ éŒ¯èª¤è©³æƒ…"):
                st.code(str(e))

            # é¡¯ç¤ºå‚™ç”¨å…§å®¹
            show_fallback_content(page_key, page_config)
    else:
        # é¡¯ç¤ºå‚™ç”¨å…§å®¹
        show_fallback_content(page_key, page_config)

def show_fallback_content(page_key: str, page_config: Dict[str, Any]):
    """é¡¯ç¤ºå‚™ç”¨å…§å®¹"""
    st.warning(f"âš ï¸ {page_config['title']} åŠŸèƒ½æ­£åœ¨è¼‰å…¥ä¸­...")
    
    # æ ¹æ“šé é¢é¡å‹é¡¯ç¤ºä¸åŒçš„å‚™ç”¨å…§å®¹
    if page_key == "dashboard":
        show_dashboard_fallback()
    elif page_key == "data_management":
        show_data_management_fallback()
    elif page_key == "backtest":
        show_backtest_fallback()
    elif page_key == "portfolio_management":
        show_portfolio_fallback()
    elif page_key == "risk_management":
        show_risk_management_fallback()
    else:
        st.info(f"ğŸ“‹ {page_config['description']}")
        st.markdown("### ğŸ”§ åŠŸèƒ½é–‹ç™¼ä¸­")
        st.write("æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼")

def show_dashboard_fallback():
    """å„€è¡¨æ¿å‚™ç”¨å…§å®¹"""
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("ç¸½è³‡ç”¢", "Â¥1,000,000", "5.2%")
    
    with col2:
        st.metric("ä»Šæ—¥æ”¶ç›Š", "Â¥12,500", "1.25%")
    
    with col3:
        st.metric("æŒå€‰æ•¸é‡", "15", "2")
    
    with col4:
        st.metric("é¢¨éšªè©•åˆ†", "7.5/10", "-0.3")
    
    st.markdown("### ğŸ“ˆ å¸‚å ´æ¦‚æ³")
    st.info("å¸‚å ´æ•¸æ“šè¼‰å…¥ä¸­...")

def show_data_management_fallback():
    """æ•¸æ“šç®¡ç†å‚™ç”¨å…§å®¹"""
    st.markdown("### ğŸ“Š æ•¸æ“šæºç‹€æ…‹")
    
    data_sources = {
        "Yahoo Finance": "âœ… æ­£å¸¸",
        "å°ç£è­‰äº¤æ‰€": "âœ… æ­£å¸¸", 
        "åˆ¸å•†API": "âš ï¸ é€£æ¥ä¸­",
        "æ–°èæ•¸æ“š": "âœ… æ­£å¸¸"
    }
    
    for source, status in data_sources.items():
        st.write(f"**{source}**: {status}")
    
    if st.button("ğŸ”„ é‡æ–°é€£æ¥æ•¸æ“šæº"):
        st.success("âœ… æ•¸æ“šæºé‡æ–°é€£æ¥æˆåŠŸ")

def show_backtest_fallback():
    """å›æ¸¬åˆ†æå‚™ç”¨å…§å®¹"""
    st.markdown("### ğŸ“‰ å›æ¸¬é…ç½®")
    
    col1, col2 = st.columns(2)
    
    with col1:
        start_date = st.date_input("é–‹å§‹æ—¥æœŸ")
        strategy = st.selectbox("é¸æ“‡ç­–ç•¥", ["ç§»å‹•å¹³å‡", "RSIç­–ç•¥", "MACDç­–ç•¥"])
    
    with col2:
        end_date = st.date_input("çµæŸæ—¥æœŸ")
        initial_capital = st.number_input("åˆå§‹è³‡é‡‘", value=1000000)
    
    if st.button("ğŸš€ é–‹å§‹å›æ¸¬"):
        st.success("âœ… å›æ¸¬ä»»å‹™å·²æäº¤ï¼Œçµæœå°‡åœ¨å®Œæˆå¾Œé¡¯ç¤º")

def show_portfolio_fallback():
    """æŠ•è³‡çµ„åˆå‚™ç”¨å…§å®¹"""
    st.markdown("### ğŸ’¼ æŠ•è³‡çµ„åˆæ¦‚æ³")
    
    portfolio_data = {
        "AAPL": {"æ¬Šé‡": "25%", "æ”¶ç›Š": "+5.2%"},
        "TSLA": {"æ¬Šé‡": "20%", "æ”¶ç›Š": "+12.8%"},
        "MSFT": {"æ¬Šé‡": "15%", "æ”¶ç›Š": "+3.1%"},
        "GOOGL": {"æ¬Šé‡": "10%", "æ”¶ç›Š": "+7.5%"}
    }
    
    for symbol, data in portfolio_data.items():
        col1, col2, col3 = st.columns(3)
        with col1:
            st.write(f"**{symbol}**")
        with col2:
            st.write(data["æ¬Šé‡"])
        with col3:
            st.write(data["æ”¶ç›Š"])

def show_risk_management_fallback():
    """é¢¨éšªç®¡ç†å‚™ç”¨å…§å®¹"""
    st.markdown("### âš ï¸ é¢¨éšªæŒ‡æ¨™")
    
    risk_metrics = {
        "VaR (95%)": "-2.5%",
        "æœ€å¤§å›æ’¤": "-8.2%",
        "å¤æ™®æ¯”ç‡": "1.45",
        "æ³¢å‹•ç‡": "15.3%"
    }
    
    col1, col2 = st.columns(2)
    
    with col1:
        for metric, value in list(risk_metrics.items())[:2]:
            st.metric(metric, value)
    
    with col2:
        for metric, value in list(risk_metrics.items())[2:]:
            st.metric(metric, value)

def main():
    """ä¸»å‡½æ•¸ (æ•´åˆç‰ˆï¼šv3.0 ç¾ä»£åŒ–è¨­è¨ˆ + v2.2 ç©©å®šæ€§)"""
    try:
        # è¨­å®šé é¢é…ç½®
        setup_page_config()

        # æ‡‰ç”¨è‡ªå®šç¾©æ¨£å¼ (ä¾†è‡ª v3.0)
        apply_custom_css()

        # åˆå§‹åŒ– session state
        if "current_view" not in st.session_state:
            st.session_state.current_view = "dashboard"

        # é¡¯ç¤ºå´é‚Šæ¬„
        show_sidebar()

        # æ ¹æ“šç•¶å‰è¦–åœ–é¡¯ç¤ºå…§å®¹
        current_view = st.session_state.get("current_view", "dashboard")

        if current_view == "dashboard":
            # ç¾ä»£åŒ–å„€è¡¨æ¿æ¨¡å¼
            show_dashboard_mode()
        else:
            # é¡¯ç¤ºå…·é«”åŠŸèƒ½é é¢
            render_page(current_view)

        # æ€§èƒ½ç›£æ§ (v2.2 ç©©å®šåŠŸèƒ½)
        if st.session_state.get("show_performance", False):
            with st.expander("ğŸ“Š æ€§èƒ½ç›£æ§", expanded=True):
                st.info("ç³»çµ±é‹è¡Œæ­£å¸¸ï¼ŒéŸ¿æ‡‰æ™‚é–“ < 2ç§’")
                if st.button("é—œé–‰ç›£æ§"):
                    st.session_state["show_performance"] = False
                    st.rerun()

        # è‡ªå‹•åˆ·æ–°åŠŸèƒ½ (ä¾†è‡ª v3.0)
        if st.session_state.get("auto_refresh", False):
            refresh_interval = st.session_state.get("refresh_interval", 30)
            if "last_refresh" not in st.session_state:
                st.session_state.last_refresh = datetime.now()

            next_refresh = st.session_state.last_refresh + timedelta(seconds=refresh_interval)
            time_until_refresh = (next_refresh - datetime.now()).total_seconds()

            if time_until_refresh <= 0:
                st.session_state.last_refresh = datetime.now()
                st.rerun()

        # é è…³ä¿¡æ¯
        st.markdown("---")
        st.markdown("""
        <div style="text-align: center; color: #666; padding: 2rem;">
            <p>ğŸš€ AIæ™ºèƒ½äº¤æ˜“å¹³å° v3.0 Production | æ·±è‰²ä¸»é¡Œå„ªåŒ–ç‰ˆ</p>
            <p>ğŸ’¡ æç¤ºï¼šä½¿ç”¨å´é‚Šæ¬„å¿«é€Ÿå°èˆªå’Œè¨ªå•è¨­ç½®</p>
        </div>
        """, unsafe_allow_html=True)

    except Exception as e:
        logger.error(f"Web UI åŸ·è¡Œå¤±æ•—: {e}")

        # ä½¿ç”¨å¢å¼·éŒ¯èª¤è™•ç†
        if ENHANCED_ERROR_HANDLER_AVAILABLE:
            show_error_with_solutions(e, {
                "component": "Web UI",
                "current_view": st.session_state.get("current_view", "unknown"),
                "user_agent": st.context.headers.get("user-agent", "unknown") if hasattr(st, 'context') else "unknown"
            })
        else:
            # å›é€€åˆ°åŸºæœ¬éŒ¯èª¤è™•ç†
            st.error(f"âŒ ç³»çµ±éŒ¯èª¤: {e}")
            st.info("è«‹é‡æ–°æ•´ç†é é¢æˆ–è¯ç¹«æŠ€è¡“æ”¯æ´")

        # éŒ¯èª¤æ¢å¾©é¸é … (å¢å¼·ç‰ˆ)
        st.markdown("### ğŸ”§ éŒ¯èª¤æ¢å¾©é¸é …")
        col1, col2, col3, col4 = st.columns(4)

        with col1:
            if st.button("ğŸ  è¿”å›ä¸»é ", type="primary"):
                st.session_state.current_view = "dashboard"
                st.rerun()

        with col2:
            if st.button("ğŸ”„ é‡æ–°è¼‰å…¥", type="secondary"):
                st.rerun()

        with col3:
            if st.button("ğŸ§¹ æ¸…é™¤ç·©å­˜", type="secondary"):
                for key in list(st.session_state.keys()):
                    if key not in ["current_view"]:
                        del st.session_state[key]
                st.rerun()

        with col4:
            if st.button("ğŸ” ç³»çµ±è¨ºæ–·", type="secondary"):
                st.session_state.current_view = "system_status_enhanced"
                st.rerun()

if __name__ == "__main__":
    main()
