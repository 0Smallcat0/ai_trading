"""æŠ•è³‡çµ„åˆç®¡ç†çµ„ä»¶

æ­¤æ¨¡çµ„æ•´åˆæ‰€æœ‰æŠ•è³‡çµ„åˆç®¡ç†ç›¸é—œåŠŸèƒ½ï¼Œæä¾›çµ±ä¸€çš„æŠ•è³‡çµ„åˆç®¡ç†ä»‹é¢ï¼š
- æŠ•è³‡çµ„åˆç®¡ç†åŸºæœ¬åŠŸèƒ½
- æ–‡æœ¬åˆ†æåŠŸèƒ½

ä¸»è¦åŠŸèƒ½ï¼š
- çµ±ä¸€çš„æŠ•è³‡çµ„åˆç®¡ç†å…¥å£
- çµ„åˆé…ç½®å’Œå„ªåŒ–
- æ–‡æœ¬åˆ†æå’Œå¸‚å ´æƒ…ç·’
- ç¸¾æ•ˆè©•ä¼°å’Œå ±å‘Š
- çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

Example:
    >>> from src.ui.components.portfolio_management import show
    >>> show()  # é¡¯ç¤ºæŠ•è³‡çµ„åˆç®¡ç†ä¸»ä»‹é¢
"""

import logging

import streamlit as st

logger = logging.getLogger(__name__)


def show() -> None:
    """é¡¯ç¤ºæŠ•è³‡çµ„åˆç®¡ç†ä¸»ä»‹é¢.

    æ•´åˆæ‰€æœ‰æŠ•è³‡çµ„åˆç®¡ç†ç›¸é—œåŠŸèƒ½åˆ°çµ±ä¸€çš„æ¨™ç±¤é ä»‹é¢ä¸­ã€‚
    æä¾›2å€‹å­åŠŸèƒ½çš„å®Œæ•´æ•´åˆï¼ŒåŒ…æ‹¬éŒ¯èª¤è™•ç†å’Œç‹€æ…‹ç®¡ç†ã€‚

    ä¸»è¦å­åŠŸèƒ½ï¼š
    - æŠ•è³‡çµ„åˆç®¡ç†ï¼šçµ„åˆé…ç½®ã€å„ªåŒ–ã€ç¸¾æ•ˆè©•ä¼°ç­‰åŠŸèƒ½
    - æ–‡æœ¬åˆ†æï¼šå¸‚å ´æƒ…ç·’åˆ†æã€æ–°èåˆ†æç­‰åŠŸèƒ½

    Side Effects:
        - æ¸²æŸ“ Streamlit ç•Œé¢çµ„ä»¶
        - å¯èƒ½ä¿®æ”¹ st.session_state ä¸­çš„ç›¸é—œç‹€æ…‹

    Example:
        >>> show()  # é¡¯ç¤ºå®Œæ•´çš„æŠ•è³‡çµ„åˆç®¡ç†ä»‹é¢

    Note:
        æ­¤å‡½æ•¸æ•´åˆäº†å¤šå€‹åŸæœ‰é é¢çš„åŠŸèƒ½ï¼Œä¿æŒå‘å¾Œå…¼å®¹æ€§ã€‚
        å¦‚æœæŸå€‹å­åŠŸèƒ½ä¸å¯ç”¨ï¼Œæœƒé¡¯ç¤ºç›¸æ‡‰çš„éŒ¯èª¤è¨Šæ¯ã€‚
    """
    try:
        st.title("ğŸ’¼ æŠ•è³‡çµ„åˆç®¡ç†")
        st.markdown("---")

        # å‰µå»ºå­åŠŸèƒ½æ¨™ç±¤é 
        tab1, tab2 = st.tabs([
            "ğŸ’¼ æŠ•è³‡çµ„åˆ",
            "ğŸ“ æ–‡æœ¬åˆ†æ"
        ])

        with tab1:
            _show_portfolio_management()

        with tab2:
            _show_text_analysis()

    except Exception as e:
        logger.error("é¡¯ç¤ºæŠ•è³‡çµ„åˆç®¡ç†ä»‹é¢æ™‚ç™¼ç”ŸéŒ¯èª¤: %s", e, exc_info=True)
        st.error("âŒ æŠ•è³‡çµ„åˆç®¡ç†ä»‹é¢è¼‰å…¥å¤±æ•—")
        with st.expander("éŒ¯èª¤è©³æƒ…"):
            st.code(str(e))


def _show_portfolio_management() -> None:
    """é¡¯ç¤ºæŠ•è³‡çµ„åˆç®¡ç†åŠŸèƒ½.

    èª¿ç”¨åŸæœ‰çš„ portfolio_management é é¢åŠŸèƒ½ã€‚

    Raises:
        Exception: ç•¶è¼‰å…¥æŠ•è³‡çµ„åˆç®¡ç†é é¢å¤±æ•—æ™‚
    """
    try:
        # å‹•æ…‹å°å…¥ä»¥é¿å…å¾ªç’°ä¾è³´
        from src.ui.pages.portfolio_management import show as portfolio_show
        portfolio_show()

    except ImportError as e:
        logger.warning("ç„¡æ³•å°å…¥æŠ•è³‡çµ„åˆç®¡ç†é é¢: %s", e)
        st.warning("âš ï¸ æŠ•è³‡çµ„åˆç®¡ç†åŠŸèƒ½æš«æ™‚ä¸å¯ç”¨")
        _show_fallback_portfolio_management()

    except Exception as e:
        logger.error("é¡¯ç¤ºæŠ•è³‡çµ„åˆç®¡ç†æ™‚ç™¼ç”ŸéŒ¯èª¤: %s", e, exc_info=True)
        st.error("âŒ æŠ•è³‡çµ„åˆç®¡ç†åŠŸèƒ½è¼‰å…¥å¤±æ•—")
        _show_fallback_portfolio_management()


def _show_text_analysis() -> None:
    """é¡¯ç¤ºæ–‡æœ¬åˆ†æåŠŸèƒ½.

    èª¿ç”¨åŸæœ‰çš„ text_analysis é é¢åŠŸèƒ½ã€‚

    Raises:
        Exception: ç•¶è¼‰å…¥æ–‡æœ¬åˆ†æé é¢å¤±æ•—æ™‚
    """
    try:
        # å‹•æ…‹å°å…¥ä»¥é¿å…å¾ªç’°ä¾è³´
        from src.ui.pages.text_analysis import show as text_show
        text_show()

    except ImportError as e:
        logger.warning("ç„¡æ³•å°å…¥æ–‡æœ¬åˆ†æé é¢: %s", e)
        st.warning("âš ï¸ æ–‡æœ¬åˆ†æåŠŸèƒ½æš«æ™‚ä¸å¯ç”¨")
        _show_fallback_text_analysis()

    except Exception as e:
        logger.error("é¡¯ç¤ºæ–‡æœ¬åˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤: %s", e, exc_info=True)
        st.error("âŒ æ–‡æœ¬åˆ†æåŠŸèƒ½è¼‰å…¥å¤±æ•—")
        _show_fallback_text_analysis()


def _show_fallback_portfolio_management() -> None:
    """æŠ•è³‡çµ„åˆç®¡ç†çš„å‚™ç”¨é¡¯ç¤ºå‡½æ•¸.

    ç•¶åŸæœ‰çš„æŠ•è³‡çµ„åˆç®¡ç†é é¢ç„¡æ³•è¼‰å…¥æ™‚ï¼Œé¡¯ç¤ºåŸºæœ¬çš„åŠŸèƒ½èªªæ˜ã€‚
    """
    st.info("ğŸ’¼ æŠ•è³‡çµ„åˆç®¡ç†åŠŸèƒ½æ­£åœ¨è¼‰å…¥ä¸­...")

    st.markdown("""
    **æŠ•è³‡çµ„åˆç®¡ç†ç³»çµ±** æä¾›å®Œæ•´çš„çµ„åˆç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
    - ğŸ“Š **çµ„åˆé…ç½®**: è³‡ç”¢é…ç½®å’Œæ¬Šé‡ç®¡ç†
    - ğŸ¯ **çµ„åˆå„ªåŒ–**: åŸºæ–¼ç¾ä»£æŠ•è³‡çµ„åˆç†è«–çš„å„ªåŒ–
    - ğŸ“ˆ **ç¸¾æ•ˆè©•ä¼°**: çµ„åˆç¸¾æ•ˆåˆ†æå’Œæ­¸å› åˆ†æ
    - âš–ï¸ **é¢¨éšªåˆ†æ•£**: é¢¨éšªåˆ†æ•£å’Œç›¸é—œæ€§åˆ†æ
    - ğŸ“‹ **å†å¹³è¡¡**: çµ„åˆå†å¹³è¡¡å’Œèª¿æ•´å»ºè­°
    """)

    # é¡¯ç¤ºçµ„åˆæ¦‚è¦½
    st.markdown("### ğŸ“Š æŠ•è³‡çµ„åˆæ¦‚è¦½")

    col1, col2, col3, col4 = st.columns(4)

    with col1:
        st.metric("ç¸½å¸‚å€¼", "$125,430", "+$2,340 (+1.9%)")

    with col2:
        st.metric("æŒå€‰æ•¸é‡", "12", "0")

    with col3:
        st.metric("å¹´åŒ–æ”¶ç›Š", "12.5%", "+2.1%")

    with col4:
        st.metric("å¤æ™®æ¯”ç‡", "1.35", "+0.15")
    
    # é¡¯ç¤ºè³‡ç”¢é…ç½®
    st.markdown("### ğŸ¥§ è³‡ç”¢é…ç½®")

    allocation_data = [
        {"è³‡ç”¢é¡åˆ¥": "è‚¡ç¥¨", "é…ç½®æ¯”ä¾‹": "70%", "ç›®æ¨™æ¯”ä¾‹": "65%", "åå·®": "+5%"},
        {"è³‡ç”¢é¡åˆ¥": "å‚µåˆ¸", "é…ç½®æ¯”ä¾‹": "20%", "ç›®æ¨™æ¯”ä¾‹": "25%", "åå·®": "-5%"},
        {"è³‡ç”¢é¡åˆ¥": "ç¾é‡‘", "é…ç½®æ¯”ä¾‹": "10%", "ç›®æ¨™æ¯”ä¾‹": "10%", "åå·®": "0%"}
    ]

    for allocation in allocation_data:
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.write(f"**{allocation['è³‡ç”¢é¡åˆ¥']}**")
        with col2:
            st.write(f"ç•¶å‰: {allocation['é…ç½®æ¯”ä¾‹']}")
        with col3:
            st.write(f"ç›®æ¨™: {allocation['ç›®æ¨™æ¯”ä¾‹']}")
        with col4:
            deviation_color = ("ğŸ”´" if allocation['åå·®'].startswith('+') else
                              "ğŸŸ¢" if allocation['åå·®'].startswith('-') else "âšª")
            st.write(f"{deviation_color} {allocation['åå·®']}")
    
    # é¡¯ç¤ºæŒå€‰æ˜ç´°
    st.markdown("### ğŸ“‹ æŒå€‰æ˜ç´°")

    holdings = [
        {"è‚¡ç¥¨": "AAPL", "æ•¸é‡": "100", "å¸‚å€¼": "$15,000",
         "æ¬Šé‡": "12%", "æ”¶ç›Š": "+8.5%"},
        {"è‚¡ç¥¨": "GOOGL", "æ•¸é‡": "50", "å¸‚å€¼": "$12,500",
         "æ¬Šé‡": "10%", "æ”¶ç›Š": "+12.3%"},
        {"è‚¡ç¥¨": "MSFT", "æ•¸é‡": "75", "å¸‚å€¼": "$22,500",
         "æ¬Šé‡": "18%", "æ”¶ç›Š": "+6.8%"},
        {"è‚¡ç¥¨": "TSLA", "æ•¸é‡": "25", "å¸‚å€¼": "$5,000",
         "æ¬Šé‡": "4%", "æ”¶ç›Š": "-2.1%"}
    ]

    for holding in holdings:
        with st.expander(f"{holding['è‚¡ç¥¨']} - æ¬Šé‡: {holding['æ¬Šé‡']}"):
            col1, col2, col3 = st.columns(3)
            with col1:
                st.write(f"**æ•¸é‡**: {holding['æ•¸é‡']}")
                st.write(f"**å¸‚å€¼**: {holding['å¸‚å€¼']}")
            with col2:
                st.write(f"**æ¬Šé‡**: {holding['æ¬Šé‡']}")
                st.write(f"**æ”¶ç›Š**: {holding['æ”¶ç›Š']}")
            with col3:
                if st.button("èª¿æ•´", key=f"adjust_{holding['è‚¡ç¥¨']}"):
                    st.info(f"{holding['è‚¡ç¥¨']} èª¿æ•´åŠŸèƒ½é–‹ç™¼ä¸­...")
    
    # å†å¹³è¡¡å»ºè­°
    st.markdown("### âš–ï¸ å†å¹³è¡¡å»ºè­°")

    rebalance_suggestions = [
        {"æ“ä½œ": "æ¸›æŒ", "è‚¡ç¥¨": "MSFT", "å»ºè­°": "æ¸›æŒ3%", "åŸå› ": "æ¬Šé‡è¶…é…"},
        {"æ“ä½œ": "å¢æŒ", "è‚¡ç¥¨": "å‚µåˆ¸ETF", "å»ºè­°": "å¢æŒ5%", "åŸå› ": "å‚µåˆ¸é…ç½®ä¸è¶³"},
        {"æ“ä½œ": "ä¿æŒ", "è‚¡ç¥¨": "AAPL", "å»ºè­°": "ç¶­æŒç¾ç‹€", "åŸå› ": "é…ç½®åˆç†"}
    ]

    for suggestion in rebalance_suggestions:
        action_color = ("ğŸ”´" if suggestion["æ“ä½œ"] == "æ¸›æŒ" else
                       "ğŸŸ¢" if suggestion["æ“ä½œ"] == "å¢æŒ" else "ğŸŸ¡")
        st.markdown(f"{action_color} **{suggestion['æ“ä½œ']} {suggestion['è‚¡ç¥¨']}**: "
                   f"{suggestion['å»ºè­°']} - {suggestion['åŸå› ']}")


def _show_fallback_text_analysis() -> None:
    """æ–‡æœ¬åˆ†æçš„å‚™ç”¨é¡¯ç¤ºå‡½æ•¸.

    ç•¶åŸæœ‰çš„æ–‡æœ¬åˆ†æé é¢ç„¡æ³•è¼‰å…¥æ™‚ï¼Œé¡¯ç¤ºåŸºæœ¬çš„åŠŸèƒ½èªªæ˜ã€‚
    """
    st.info("ğŸ“ æ–‡æœ¬åˆ†æåŠŸèƒ½æ­£åœ¨è¼‰å…¥ä¸­...")

    st.markdown("""
    **æ–‡æœ¬åˆ†æç³»çµ±** æä¾›å¸‚å ´æƒ…ç·’å’Œæ–‡æœ¬åˆ†æåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
    - ğŸ“° **æ–°èåˆ†æ**: è²¡ç¶“æ–°èæƒ…æ„Ÿåˆ†æå’Œé—œéµä¿¡æ¯æå–
    - ğŸ“Š **æƒ…ç·’æŒ‡æ¨™**: å¸‚å ´æƒ…ç·’æŒ‡æ¨™å’ŒæŠ•è³‡è€…æƒ…ç·’åˆ†æ
    - ğŸ” **é—œéµè©è¿½è¹¤**: é—œéµè©å’Œè©±é¡Œè¶¨å‹¢è¿½è¹¤
    - ğŸ“ˆ **å½±éŸ¿è©•ä¼°**: æ–°èäº‹ä»¶å°è‚¡åƒ¹çš„å½±éŸ¿è©•ä¼°
    - ğŸ¯ **æŠ•è³‡ä¿¡è™Ÿ**: åŸºæ–¼æ–‡æœ¬åˆ†æçš„æŠ•è³‡ä¿¡è™Ÿç”Ÿæˆ
    """)

    # é¡¯ç¤ºæƒ…ç·’åˆ†ææ¦‚è¦½
    st.markdown("### ğŸ“Š å¸‚å ´æƒ…ç·’æ¦‚è¦½")

    col1, col2, col3, col4 = st.columns(4)

    with col1:
        st.metric("æ•´é«”æƒ…ç·’", "æ¨‚è§€", "ğŸ“ˆ")

    with col2:
        st.metric("æƒ…ç·’æŒ‡æ•¸", "72", "+5")

    with col3:
        st.metric("æ–°èæ•¸é‡", "156", "+23")

    with col4:
        st.metric("é—œéµäº‹ä»¶", "3", "+1")
    
    # é¡¯ç¤ºæ–°èåˆ†æ
    st.markdown("### ğŸ“° æœ€æ–°æ–°èåˆ†æ")

    news_analysis = [
        {
            "æ¨™é¡Œ": "ç§‘æŠ€è‚¡å¼·å‹¢åå½ˆï¼ŒAIæ¦‚å¿µè‚¡é ˜æ¼²",
            "æƒ…ç·’": "ğŸŸ¢ æ­£é¢",
            "å½±éŸ¿": "é«˜",
            "ç›¸é—œè‚¡ç¥¨": "NVDA, GOOGL, MSFT",
            "ä¿¡å¿ƒåº¦": "85%"
        },
        {
            "æ¨™é¡Œ": "è¯æº–æœƒæš—ç¤ºå¯èƒ½æš«åœå‡æ¯",
            "æƒ…ç·’": "ğŸŸ¢ æ­£é¢",
            "å½±éŸ¿": "ä¸­",
            "ç›¸é—œè‚¡ç¥¨": "æ•´é«”å¸‚å ´",
            "ä¿¡å¿ƒåº¦": "78%"
        },
        {
            "æ¨™é¡Œ": "èƒ½æºåƒ¹æ ¼ä¸Šæ¼²å¼•ç™¼é€šè„¹æ“”æ†‚",
            "æƒ…ç·’": "ğŸ”´ è² é¢",
            "å½±éŸ¿": "ä¸­",
            "ç›¸é—œè‚¡ç¥¨": "XOM, CVX",
            "ä¿¡å¿ƒåº¦": "72%"
        }
    ]

    for news in news_analysis:
        with st.expander(f"{news['æƒ…ç·’']} {news['æ¨™é¡Œ']}"):
            col1, col2 = st.columns(2)
            with col1:
                st.write(f"**æƒ…ç·’**: {news['æƒ…ç·’']}")
                st.write(f"**å½±éŸ¿ç¨‹åº¦**: {news['å½±éŸ¿']}")
            with col2:
                st.write(f"**ç›¸é—œè‚¡ç¥¨**: {news['ç›¸é—œè‚¡ç¥¨']}")
                st.write(f"**ä¿¡å¿ƒåº¦**: {news['ä¿¡å¿ƒåº¦']}")
    
    # é¡¯ç¤ºé—œéµè©è¿½è¹¤
    st.markdown("### ğŸ” ç†±é–€é—œéµè©")

    keywords = [
        {"é—œéµè©": "äººå·¥æ™ºèƒ½", "æåŠæ¬¡æ•¸": "89", "è¶¨å‹¢": "ğŸ“ˆ ä¸Šå‡"},
        {"é—œéµè©": "å‡æ¯", "æåŠæ¬¡æ•¸": "67", "è¶¨å‹¢": "ğŸ“‰ ä¸‹é™"},
        {"é—œéµè©": "é€šè„¹", "æåŠæ¬¡æ•¸": "45", "è¶¨å‹¢": "ğŸ“ˆ ä¸Šå‡"},
        {"é—œéµè©": "è²¡å ±", "æåŠæ¬¡æ•¸": "34", "è¶¨å‹¢": "â¡ï¸ æŒå¹³"}
    ]

    for keyword in keywords:
        col1, col2, col3 = st.columns(3)
        with col1:
            st.write(f"**{keyword['é—œéµè©']}**")
        with col2:
            st.write(f"æåŠ: {keyword['æåŠæ¬¡æ•¸']}æ¬¡")
        with col3:
            st.write(f"{keyword['è¶¨å‹¢']}")

    # æŠ•è³‡ä¿¡è™Ÿ
    st.markdown("### ğŸ¯ åŸºæ–¼æ–‡æœ¬çš„æŠ•è³‡ä¿¡è™Ÿ")

    signals = [
        {"ä¿¡è™Ÿ": "è²·å…¥", "è‚¡ç¥¨": "NVDA", "å¼·åº¦": "å¼·", "åŸå› ": "AIç›¸é—œæ­£é¢æ–°èå¢åŠ "},
        {"ä¿¡è™Ÿ": "è§€æœ›", "è‚¡ç¥¨": "éŠ€è¡Œè‚¡", "å¼·åº¦": "ä¸­", "åŸå› ": "å‡æ¯é æœŸä¸æ˜ç¢º"},
        {"ä¿¡è™Ÿ": "æ¸›æŒ", "è‚¡ç¥¨": "èƒ½æºè‚¡", "å¼·åº¦": "å¼±", "åŸå› ": "ç’°ä¿æ”¿ç­–è² é¢å½±éŸ¿"}
    ]

    for signal in signals:
        signal_color = ("ğŸŸ¢" if signal["ä¿¡è™Ÿ"] == "è²·å…¥" else
                       "ğŸŸ¡" if signal["ä¿¡è™Ÿ"] == "è§€æœ›" else "ğŸ”´")
        st.markdown(f"{signal_color} **{signal['ä¿¡è™Ÿ']} {signal['è‚¡ç¥¨']}** "
                   f"(å¼·åº¦: {signal['å¼·åº¦']}) - {signal['åŸå› ']}")


# è¼”åŠ©å‡½æ•¸
def get_portfolio_status() -> dict:
    """ç²å–æŠ•è³‡çµ„åˆç‹€æ…‹ä¿¡æ¯.

    Returns:
        dict: åŒ…å«æŠ•è³‡çµ„åˆç‹€æ…‹çš„å­—å…¸

    Example:
        >>> status = get_portfolio_status()
        >>> print(status['total_value'])
        125430
    """
    return {
        'total_value': 125430,
        'holdings_count': 12,
        'annual_return': 12.5,
        'sharpe_ratio': 1.35
    }


def validate_portfolio_config(config: dict) -> bool:
    """é©—è­‰æŠ•è³‡çµ„åˆé…ç½®.

    Args:
        config: æŠ•è³‡çµ„åˆé…ç½®å­—å…¸

    Returns:
        bool: é…ç½®æ˜¯å¦æœ‰æ•ˆ

    Example:
        >>> config = {'stocks': 70, 'bonds': 20, 'cash': 10}
        >>> is_valid = validate_portfolio_config(config)
        >>> print(is_valid)
        True
    """
    required_fields = ['stocks', 'bonds', 'cash']
    if not all(field in config for field in required_fields):
        return False

    # æª¢æŸ¥é…ç½®æ¯”ä¾‹ç¸½å’Œæ˜¯å¦ç‚º100%
    total = sum(config[field] for field in required_fields)
    return abs(total - 100) < 0.01
