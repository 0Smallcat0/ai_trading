"""å¸‚å ´ç›£æ§çµ„ä»¶

æ­¤æ¨¡çµ„æ•´åˆæ‰€æœ‰å¸‚å ´ç›£æ§ç›¸é—œåŠŸèƒ½ï¼Œæä¾›çµ±ä¸€çš„å¸‚å ´ç›£æ§ä»‹é¢ï¼š
- å¸‚å ´çœ‹ç›¤åŠŸèƒ½
- å³æ™‚æ•¸æ“šå„€è¡¨æ¿

ä¸»è¦åŠŸèƒ½ï¼š
- çµ±ä¸€çš„å¸‚å ´ç›£æ§å…¥å£
- å³æ™‚è¡Œæƒ…æ•¸æ“šå±•ç¤º
- å¸‚å ´æ¦‚è¦½å’Œåˆ†æ
- æŠ•è³‡çµ„åˆç›£æ§
- çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

Example:
    >>> from src.ui.components.market_monitoring import show
    >>> show()  # é¡¯ç¤ºå¸‚å ´ç›£æ§ä¸»ä»‹é¢
"""

import logging
from typing import Optional

import streamlit as st

logger = logging.getLogger(__name__)


def show() -> None:
    """é¡¯ç¤ºå¸‚å ´ç›£æ§ä¸»ä»‹é¢.
    
    æ•´åˆæ‰€æœ‰å¸‚å ´ç›£æ§ç›¸é—œåŠŸèƒ½åˆ°çµ±ä¸€çš„æ¨™ç±¤é ä»‹é¢ä¸­ã€‚
    æä¾›2å€‹å­åŠŸèƒ½çš„å®Œæ•´æ•´åˆï¼ŒåŒ…æ‹¬éŒ¯èª¤è™•ç†å’Œç‹€æ…‹ç®¡ç†ã€‚
    
    ä¸»è¦å­åŠŸèƒ½ï¼š
    - å¸‚å ´çœ‹ç›¤ï¼šå®Œæ•´çš„å¸‚å ´çœ‹ç›¤åŠŸèƒ½ï¼ŒåŒ…æ‹¬è‡ªé¸è‚¡ã€æ¦‚å¿µæ¿å¡Šç­‰
    - å³æ™‚å„€è¡¨æ¿ï¼šå³æ™‚æ•¸æ“šç›£æ§å’Œåˆ†æå„€è¡¨æ¿
    
    Returns:
        None
        
    Side Effects:
        - æ¸²æŸ“ Streamlit ç•Œé¢çµ„ä»¶
        - å¯èƒ½ä¿®æ”¹ st.session_state ä¸­çš„ç›¸é—œç‹€æ…‹
        
    Example:
        >>> show()  # é¡¯ç¤ºå®Œæ•´çš„å¸‚å ´ç›£æ§ä»‹é¢
        
    Note:
        æ­¤å‡½æ•¸æ•´åˆäº†å¤šå€‹åŸæœ‰é é¢çš„åŠŸèƒ½ï¼Œä¿æŒå‘å¾Œå…¼å®¹æ€§ã€‚
        å¦‚æœæŸå€‹å­åŠŸèƒ½ä¸å¯ç”¨ï¼Œæœƒé¡¯ç¤ºç›¸æ‡‰çš„éŒ¯èª¤è¨Šæ¯ã€‚
    """
    try:
        st.title("ğŸ“º å¸‚å ´ç›£æ§")
        st.markdown("---")
        
        # å‰µå»ºå­åŠŸèƒ½æ¨™ç±¤é 
        tab1, tab2 = st.tabs([
            "ğŸ“ˆ å¸‚å ´çœ‹ç›¤",
            "ğŸ“Š å³æ™‚å„€è¡¨æ¿"
        ])
        
        with tab1:
            _show_market_watch()
            
        with tab2:
            _show_realtime_dashboard()
            
    except Exception as e:
        logger.error("é¡¯ç¤ºå¸‚å ´ç›£æ§ä»‹é¢æ™‚ç™¼ç”ŸéŒ¯èª¤: %s", e, exc_info=True)
        st.error("âŒ å¸‚å ´ç›£æ§ä»‹é¢è¼‰å…¥å¤±æ•—")
        with st.expander("éŒ¯èª¤è©³æƒ…"):
            st.code(str(e))


def _show_market_watch() -> None:
    """é¡¯ç¤ºå¸‚å ´çœ‹ç›¤åŠŸèƒ½.
    
    èª¿ç”¨åŸæœ‰çš„ market_watch é é¢åŠŸèƒ½ã€‚
    
    Returns:
        None
        
    Raises:
        Exception: ç•¶è¼‰å…¥å¸‚å ´çœ‹ç›¤é é¢å¤±æ•—æ™‚
    """
    try:
        from src.ui.pages.market_watch import render_market_watch_page
        render_market_watch_page()
        
    except ImportError as e:
        logger.warning("ç„¡æ³•å°å…¥å¸‚å ´çœ‹ç›¤é é¢: %s", e)
        st.warning("âš ï¸ å¸‚å ´çœ‹ç›¤åŠŸèƒ½æš«æ™‚ä¸å¯ç”¨")
        _show_fallback_market_watch()
        
    except Exception as e:
        logger.error("é¡¯ç¤ºå¸‚å ´çœ‹ç›¤æ™‚ç™¼ç”ŸéŒ¯èª¤: %s", e, exc_info=True)
        st.error("âŒ å¸‚å ´çœ‹ç›¤åŠŸèƒ½è¼‰å…¥å¤±æ•—")
        _show_fallback_market_watch()


def _show_realtime_dashboard() -> None:
    """é¡¯ç¤ºå³æ™‚å„€è¡¨æ¿åŠŸèƒ½.
    
    èª¿ç”¨åŸæœ‰çš„ realtime_dashboard é é¢åŠŸèƒ½ã€‚
    
    Returns:
        None
        
    Raises:
        Exception: ç•¶è¼‰å…¥å³æ™‚å„€è¡¨æ¿é é¢å¤±æ•—æ™‚
    """
    try:
        from src.ui.pages.realtime_dashboard import show as realtime_show
        realtime_show()
        
    except ImportError as e:
        logger.warning("ç„¡æ³•å°å…¥å³æ™‚å„€è¡¨æ¿é é¢: %s", e)
        st.warning("âš ï¸ å³æ™‚å„€è¡¨æ¿åŠŸèƒ½æš«æ™‚ä¸å¯ç”¨")
        _show_fallback_realtime_dashboard()
        
    except Exception as e:
        logger.error("é¡¯ç¤ºå³æ™‚å„€è¡¨æ¿æ™‚ç™¼ç”ŸéŒ¯èª¤: %s", e, exc_info=True)
        st.error("âŒ å³æ™‚å„€è¡¨æ¿åŠŸèƒ½è¼‰å…¥å¤±æ•—")
        _show_fallback_realtime_dashboard()


def _show_fallback_market_watch() -> None:
    """å¸‚å ´çœ‹ç›¤çš„å‚™ç”¨é¡¯ç¤ºå‡½æ•¸.
    
    ç•¶åŸæœ‰çš„å¸‚å ´çœ‹ç›¤é é¢ç„¡æ³•è¼‰å…¥æ™‚ï¼Œé¡¯ç¤ºåŸºæœ¬çš„åŠŸèƒ½èªªæ˜ã€‚
    
    Returns:
        None
    """
    st.info("ğŸ“ˆ å¸‚å ´çœ‹ç›¤åŠŸèƒ½æ­£åœ¨è¼‰å…¥ä¸­...")
    
    st.markdown("""
    **å¸‚å ´çœ‹ç›¤ç³»çµ±** æä¾›å®Œæ•´çš„å¸‚å ´ç›£æ§åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
    - ğŸ“Š **è‡ªé¸è‚¡ç›£æ§**: å€‹äººåŒ–çš„è‚¡ç¥¨ç›£æ§é¢æ¿
    - ğŸ”¥ **æ¦‚å¿µæ¿å¡Š**: ç†±é–€æ¦‚å¿µæ¿å¡Šæ¼²å¹…æ’è¡Œ
    - ğŸ‰ **é¾è™æ¦œ**: å¤§é¡äº¤æ˜“å’Œæ©Ÿæ§‹å‹•å‘
    - ğŸ“ˆ **æ¼²åœæ¿**: æ¼²åœè‚¡ç¥¨æ± å’Œåˆ†æ
    - ğŸš¨ **é è­¦ç³»çµ±**: åƒ¹æ ¼å’ŒæŠ€è¡“æŒ‡æ¨™é è­¦
    """)
    
    # é¡¯ç¤ºå¸‚å ´æ¦‚è¦½
    st.markdown("### ğŸ“Š å¸‚å ´æ¦‚è¦½")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("ä¸Šè­‰æŒ‡æ•¸", "3,245.67", "+12.34 (+0.38%)")
    
    with col2:
        st.metric("æ·±è­‰æˆæŒ‡", "12,456.78", "-23.45 (-0.19%)")
    
    with col3:
        st.metric("å‰µæ¥­æ¿æŒ‡", "2,567.89", "+45.67 (+1.81%)")
    
    with col4:
        st.metric("æ»¬æ·±300", "4,123.45", "+8.90 (+0.22%)")
    
    # é¡¯ç¤ºè‡ªé¸è‚¡
    st.markdown("### ğŸ“ˆ è‡ªé¸è‚¡ç›£æ§")
    
    watchlist = [
        {"ä»£ç¢¼": "000001", "åç¨±": "å¹³å®‰éŠ€è¡Œ", "ç¾åƒ¹": "12.34", "æ¼²è·Œ": "+0.56", "æ¼²è·Œå¹…": "+4.75%", "æˆäº¤é‡": "1.2å„„"},
        {"ä»£ç¢¼": "000002", "åç¨±": "è¬ç§‘A", "ç¾åƒ¹": "23.45", "æ¼²è·Œ": "-0.23", "æ¼²è·Œå¹…": "-0.97%", "æˆäº¤é‡": "8,500è¬"},
        {"ä»£ç¢¼": "600036", "åç¨±": "æ‹›å•†éŠ€è¡Œ", "ç¾åƒ¹": "45.67", "æ¼²è·Œ": "+1.23", "æ¼²è·Œå¹…": "+2.77%", "æˆäº¤é‡": "2.1å„„"},
        {"ä»£ç¢¼": "600519", "åç¨±": "è²´å·èŒ…å°", "ç¾åƒ¹": "1,678.90", "æ¼²è·Œ": "-12.34", "æ¼²è·Œå¹…": "-0.73%", "æˆäº¤é‡": "1,200è¬"}
    ]
    
    for stock in watchlist:
        color = "ğŸ”´" if stock["æ¼²è·Œ"].startswith("+") else "ğŸŸ¢" if stock["æ¼²è·Œ"].startswith("-") else "âšª"
        with st.expander(f"{color} {stock['ä»£ç¢¼']} {stock['åç¨±']} - {stock['ç¾åƒ¹']} ({stock['æ¼²è·Œå¹…']})"):
            col1, col2, col3 = st.columns(3)
            with col1:
                st.write(f"**ç¾åƒ¹**: {stock['ç¾åƒ¹']}")
                st.write(f"**æ¼²è·Œ**: {stock['æ¼²è·Œ']}")
            with col2:
                st.write(f"**æ¼²è·Œå¹…**: {stock['æ¼²è·Œå¹…']}")
                st.write(f"**æˆäº¤é‡**: {stock['æˆäº¤é‡']}")
            with col3:
                if st.button(f"æŸ¥çœ‹è©³æƒ…", key=f"detail_{stock['ä»£ç¢¼']}"):
                    st.info(f"{stock['åç¨±']} è©³ç´°ä¿¡æ¯åŠŸèƒ½é–‹ç™¼ä¸­...")
    
    # é¡¯ç¤ºç†±é–€æ¿å¡Š
    st.markdown("### ğŸ”¥ ç†±é–€æ¿å¡Š")
    
    sectors = [
        {"æ¿å¡Š": "äººå·¥æ™ºèƒ½", "æ¼²è·Œå¹…": "+3.45%", "é ˜æ¼²è‚¡": "ç§‘å¤§è¨Šé£›", "æˆäº¤é¡": "156å„„"},
        {"æ¿å¡Š": "æ–°èƒ½æºè»Š", "æ¼²è·Œå¹…": "+2.78%", "é ˜æ¼²è‚¡": "æ¯”äºè¿ª", "æˆäº¤é¡": "234å„„"},
        {"æ¿å¡Š": "åŠå°é«”", "æ¼²è·Œå¹…": "+1.92%", "é ˜æ¼²è‚¡": "ä¸­èŠ¯åœ‹éš›", "æˆäº¤é¡": "189å„„"}
    ]
    
    for sector in sectors:
        st.markdown(f"**{sector['æ¿å¡Š']}** - {sector['æ¼²è·Œå¹…']} - é ˜æ¼²: {sector['é ˜æ¼²è‚¡']} - æˆäº¤: {sector['æˆäº¤é¡']}")


def _show_fallback_realtime_dashboard() -> None:
    """å³æ™‚å„€è¡¨æ¿çš„å‚™ç”¨é¡¯ç¤ºå‡½æ•¸.
    
    ç•¶åŸæœ‰çš„å³æ™‚å„€è¡¨æ¿é é¢ç„¡æ³•è¼‰å…¥æ™‚ï¼Œé¡¯ç¤ºåŸºæœ¬çš„åŠŸèƒ½èªªæ˜ã€‚
    
    Returns:
        None
    """
    st.info("ğŸ“Š å³æ™‚å„€è¡¨æ¿åŠŸèƒ½æ­£åœ¨è¼‰å…¥ä¸­...")
    
    st.markdown("""
    **å³æ™‚æ•¸æ“šå„€è¡¨æ¿** æä¾›å³æ™‚çš„å¸‚å ´æ•¸æ“šç›£æ§ï¼ŒåŒ…æ‹¬ï¼š
    - ğŸ“ˆ **å³æ™‚è‚¡åƒ¹**: å¯¦æ™‚è‚¡åƒ¹æ›´æ–°å’Œåœ–è¡¨å±•ç¤º
    - ğŸ’¼ **æŠ•è³‡çµ„åˆ**: æŠ•è³‡çµ„åˆå³æ™‚ç›£æ§å’Œåˆ†æ
    - ğŸ“Š **å¸‚å ´åˆ†æ**: å³æ™‚å¸‚å ´åˆ†æå’ŒæŠ€è¡“æŒ‡æ¨™
    - ğŸš¨ **è­¦å ±ä¸­å¿ƒ**: åƒ¹æ ¼å’Œäº‹ä»¶è­¦å ±ç®¡ç†
    - ğŸ“° **æ–°èè³‡è¨Š**: å³æ™‚è²¡ç¶“æ–°èå’Œå…¬å‘Š
    """)
    
    # é¡¯ç¤ºé€£æ¥ç‹€æ…‹
    st.markdown("### ğŸ”— é€£æ¥ç‹€æ…‹")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric("æ•¸æ“šé€£æ¥", "æ­£å¸¸", "âœ…")
    
    with col2:
        st.metric("æ›´æ–°é »ç‡", "1ç§’", "âš¡")
    
    with col3:
        st.metric("å»¶é²", "50ms", "ğŸš€")
    
    # é¡¯ç¤ºæŠ•è³‡çµ„åˆç›£æ§
    st.markdown("### ğŸ’¼ æŠ•è³‡çµ„åˆç›£æ§")
    
    portfolio_metrics = [
        {"æŒ‡æ¨™": "ç¸½å¸‚å€¼", "æ•¸å€¼": "$125,430", "è®ŠåŒ–": "+$2,340 (+1.9%)"},
        {"æŒ‡æ¨™": "ä»Šæ—¥æç›Š", "æ•¸å€¼": "+$1,250", "è®ŠåŒ–": "+0.8%"},
        {"æŒ‡æ¨™": "æŒå€‰æ•¸é‡", "æ•¸å€¼": "12", "è®ŠåŒ–": "0"},
        {"æŒ‡æ¨™": "ç¾é‡‘é¤˜é¡", "æ•¸å€¼": "$25,670", "è®ŠåŒ–": "-$1,250"}
    ]
    
    for metric in portfolio_metrics:
        st.markdown(f"**{metric['æŒ‡æ¨™']}**: {metric['æ•¸å€¼']} ({metric['è®ŠåŒ–']})")
    
    # é¡¯ç¤ºæœ€æ–°è­¦å ±
    st.markdown("### ğŸš¨ æœ€æ–°è­¦å ±")
    
    alerts = [
        {"æ™‚é–“": "14:35", "é¡å‹": "åƒ¹æ ¼è­¦å ±", "å…§å®¹": "AAPL çªç ´ $150 é˜»åŠ›ä½", "ç‹€æ…‹": "ğŸ”´ æ–°"},
        {"æ™‚é–“": "14:20", "é¡å‹": "æˆäº¤é‡è­¦å ±", "å…§å®¹": "TSLA æˆäº¤é‡ç•°å¸¸æ”¾å¤§", "ç‹€æ…‹": "ğŸŸ¡ è™•ç†ä¸­"},
        {"æ™‚é–“": "14:05", "é¡å‹": "æŠ€è¡“æŒ‡æ¨™", "å…§å®¹": "MSFT RSI é€²å…¥è¶…è²·å€åŸŸ", "ç‹€æ…‹": "ğŸŸ¢ å·²è™•ç†"}
    ]
    
    for alert in alerts:
        st.markdown(f"**{alert['æ™‚é–“']}** {alert['ç‹€æ…‹']} {alert['é¡å‹']}: {alert['å…§å®¹']}")


# è¼”åŠ©å‡½æ•¸
def get_market_status() -> dict:
    """ç²å–å¸‚å ´ç‹€æ…‹ä¿¡æ¯.
    
    Returns:
        dict: åŒ…å«å¸‚å ´ç‹€æ…‹çš„å­—å…¸
        
    Example:
        >>> status = get_market_status()
        >>> print(status['market_open'])
        True
    """
    return {
        'market_open': True,
        'connection_status': 'connected',
        'update_frequency': 1,
        'latency': 50
    }


def validate_watchlist(symbols: list) -> bool:
    """é©—è­‰è‡ªé¸è‚¡æ¸…å–®.
    
    Args:
        symbols: è‚¡ç¥¨ä»£ç¢¼æ¸…å–®
        
    Returns:
        bool: æ¸…å–®æ˜¯å¦æœ‰æ•ˆ
        
    Example:
        >>> symbols = ['AAPL', 'GOOGL', 'MSFT']
        >>> is_valid = validate_watchlist(symbols)
        >>> print(is_valid)
        True
    """
    if not symbols or not isinstance(symbols, list):
        return False
    
    # æª¢æŸ¥æ¯å€‹è‚¡ç¥¨ä»£ç¢¼æ ¼å¼
    for symbol in symbols:
        if not isinstance(symbol, str) or len(symbol) < 1:
            return False
    
    return True
