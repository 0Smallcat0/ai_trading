name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯æ—¥å‡Œæ™¨2é»åŸ·è¡Œå®‰å…¨æƒæ
    - cron: '0 2 * * *'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry safety bandit semgrep
          poetry install
      
      - name: Create reports directory
        run: mkdir -p security-reports
      
      - name: Run Safety dependency scan
        run: |
          echo "ğŸ” åŸ·è¡Œä¾è³´æ¼æ´æƒæ..."
          poetry run safety check --json --output security-reports/safety-report.json || true
          poetry run safety check --output security-reports/safety-report.txt || true
        continue-on-error: true
      
      - name: Run pip-audit scan
        run: |
          echo "ğŸ” åŸ·è¡Œ pip-audit æƒæ..."
          pip install pip-audit
          pip-audit --format=json --output=security-reports/pip-audit-report.json || true
          pip-audit --format=cyclonedx-json --output=security-reports/pip-audit-sbom.json || true
        continue-on-error: true
      
      - name: Upload dependency scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-scan-results
          path: security-reports/
          retention-days: 30

  code-security-scan:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install poetry bandit semgrep
          poetry install
      
      - name: Create reports directory
        run: mkdir -p security-reports
      
      - name: Run Bandit security scan
        run: |
          echo "ğŸ” åŸ·è¡Œ Bandit ä»£ç¢¼å®‰å…¨æƒæ..."
          poetry run bandit -r src/ -f json -o security-reports/bandit-report.json --config .bandit || true
          poetry run bandit -r src/ -f txt -o security-reports/bandit-report.txt --config .bandit || true
        continue-on-error: true
      
      - name: Run Semgrep security scan
        run: |
          echo "ğŸ” åŸ·è¡Œ Semgrep å®‰å…¨æƒæ..."
          semgrep --config=auto --json --output=security-reports/semgrep-report.json src/ || true
          semgrep --config=auto --output=security-reports/semgrep-report.txt src/ || true
        continue-on-error: true
      
      - name: Run custom security checks
        run: |
          echo "ğŸ” åŸ·è¡Œè‡ªå®šç¾©å®‰å…¨æª¢æŸ¥..."
          python scripts/security_checks.py --output security-reports/custom-security-report.json || true
        continue-on-error: true
      
      - name: Upload code security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-security-scan-results
          path: security-reports/
          retention-days: 30

  container-security-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
      
      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          target: production
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Create reports directory
        run: mkdir -p security-reports
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.tags }}
          format: 'sarif'
          output: 'security-reports/trivy-results.sarif'
        continue-on-error: true
      
      - name: Run Trivy JSON report
        run: |
          echo "ğŸ” åŸ·è¡Œ Trivy å®¹å™¨å®‰å…¨æƒæ..."
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd)/security-reports:/reports \
            aquasec/trivy:latest image \
            --format json --output /reports/trivy-report.json \
            ${{ steps.meta.outputs.tags }} || true
        continue-on-error: true
      
      - name: Run Grype vulnerability scanner
        run: |
          echo "ğŸ” åŸ·è¡Œ Grype æ¼æ´æƒæ..."
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype ${{ steps.meta.outputs.tags }} -o json --file security-reports/grype-report.json || true
          grype ${{ steps.meta.outputs.tags }} -o table --file security-reports/grype-report.txt || true
        continue-on-error: true
      
      - name: Run Syft SBOM generation
        run: |
          echo "ğŸ” ç”Ÿæˆè»Ÿé«”ç‰©æ–™æ¸…å–® (SBOM)..."
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft ${{ steps.meta.outputs.tags }} -o spdx-json --file security-reports/sbom.spdx.json || true
          syft ${{ steps.meta.outputs.tags }} -o cyclonedx-json --file security-reports/sbom.cyclonedx.json || true
        continue-on-error: true
      
      - name: Upload container security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-security-scan-results
          path: security-reports/
          retention-days: 30
      
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'security-reports/trivy-results.sarif'

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²ä»¥æƒææ‰€æœ‰æäº¤
      
      - name: Create reports directory
        run: mkdir -p security-reports
      
      - name: Run TruffleHog secrets scan
        run: |
          echo "ğŸ” åŸ·è¡Œ TruffleHog ç§˜å¯†æƒæ..."
          docker run --rm -v $(pwd):/pwd \
            trufflesecurity/trufflehog:latest github \
            --repo https://github.com/${{ github.repository }} \
            --json > security-reports/trufflehog-report.json || true
        continue-on-error: true
      
      - name: Run GitLeaks secrets scan
        run: |
          echo "ğŸ” åŸ·è¡Œ GitLeaks ç§˜å¯†æƒæ..."
          docker run --rm -v $(pwd):/path \
            zricethezav/gitleaks:latest detect \
            --source /path --report-format json \
            --report-path /path/security-reports/gitleaks-report.json || true
        continue-on-error: true
      
      - name: Run custom secrets detection
        run: |
          echo "ğŸ” åŸ·è¡Œè‡ªå®šç¾©ç§˜å¯†æª¢æ¸¬..."
          python scripts/detect_secrets.py --output security-reports/custom-secrets-report.json || true
        continue-on-error: true
      
      - name: Upload secrets scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secrets-scan-results
          path: security-reports/
          retention-days: 30

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security-scan, container-security-scan, secrets-scan]
    if: always()
    permissions:
      contents: read
      security-events: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jinja2 markdown
      
      - name: Download all scan results
        uses: actions/download-artifact@v4
        with:
          path: all-security-reports/
      
      - name: Generate consolidated security report
        run: |
          echo "ğŸ“Š ç”Ÿæˆç¶œåˆå®‰å…¨å ±å‘Š..."
          python scripts/generate_security_report.py \
            --input-dir all-security-reports/ \
            --output-dir final-security-report/ \
            --format html,json,markdown
      
      - name: Check security thresholds
        id: security-check
        run: |
          echo "ğŸ” æª¢æŸ¥å®‰å…¨é–¾å€¼..."
          python scripts/check_security_thresholds.py \
            --report-dir final-security-report/ \
            --config config/security/thresholds.yaml \
            --output security-status.json
          
          # è¨­ç½®è¼¸å‡ºè®Šæ•¸
          if [ -f security-status.json ]; then
            SECURITY_PASSED=$(jq -r '.passed' security-status.json)
            CRITICAL_ISSUES=$(jq -r '.critical_issues' security-status.json)
            echo "security_passed=$SECURITY_PASSED" >> $GITHUB_OUTPUT
            echo "critical_issues=$CRITICAL_ISSUES" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload final security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-security-report
          path: final-security-report/
          retention-days: 90
      
      - name: Comment PR with security summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              const securityStatus = JSON.parse(fs.readFileSync('security-status.json', 'utf8'));
              const summary = fs.readFileSync('final-security-report/summary.md', 'utf8');
              
              const comment = `## ğŸ”’ å®‰å…¨æƒæçµæœ
              
              **ç‹€æ…‹**: ${securityStatus.passed ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
              **é—œéµå•é¡Œ**: ${securityStatus.critical_issues}
              **é«˜é¢¨éšªå•é¡Œ**: ${securityStatus.high_issues || 0}
              **ä¸­é¢¨éšªå•é¡Œ**: ${securityStatus.medium_issues || 0}
              
              ${summary}
              
              è©³ç´°å ±å‘Šè«‹æŸ¥çœ‹ [Security Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('ç„¡æ³•ç”Ÿæˆå®‰å…¨æ‘˜è¦è©•è«–:', error);
            }
      
      - name: Create security issue for critical vulnerabilities
        if: steps.security-check.outputs.security_passed == 'false' && steps.security-check.outputs.critical_issues > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              const securityStatus = JSON.parse(fs.readFileSync('security-status.json', 'utf8'));
              
              const issueBody = `## ğŸš¨ ç™¼ç¾é—œéµå®‰å…¨æ¼æ´
              
              **æƒææ™‚é–“**: ${new Date().toISOString()}
              **åˆ†æ”¯**: ${{ github.ref_name }}
              **æäº¤**: ${{ github.sha }}
              
              **æ¼æ´çµ±è¨ˆ**:
              - é—œéµ: ${securityStatus.critical_issues}
              - é«˜é¢¨éšª: ${securityStatus.high_issues || 0}
              - ä¸­é¢¨éšª: ${securityStatus.medium_issues || 0}
              
              **éœ€è¦ç«‹å³è™•ç†çš„é—œéµæ¼æ´**:
              ${securityStatus.critical_vulnerabilities ? securityStatus.critical_vulnerabilities.map(v => `- ${v.title}: ${v.description}`).join('\n') : 'è«‹æŸ¥çœ‹è©³ç´°å ±å‘Š'}
              
              **è©³ç´°å ±å‘Š**: [Security Scan Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              **è™•ç†å»ºè­°**:
              1. ç«‹å³åœæ­¢éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
              2. ä¿®å¾©æ‰€æœ‰é—œéµæ¼æ´
              3. é‡æ–°é‹è¡Œå®‰å…¨æƒæç¢ºèªä¿®å¾©
              4. æ›´æ–°ä¾è³´åˆ°å®‰å…¨ç‰ˆæœ¬
              
              /label security critical
              /assign @security-team
              `;
              
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ é—œéµå®‰å…¨æ¼æ´ - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody,
                labels: ['security', 'critical', 'vulnerability']
              });
            } catch (error) {
              console.log('ç„¡æ³•å‰µå»ºå®‰å…¨å•é¡Œ:', error);
            }
      
      - name: Fail workflow if critical vulnerabilities found
        if: steps.security-check.outputs.security_passed == 'false'
        run: |
          echo "âŒ ç™¼ç¾é—œéµå®‰å…¨æ¼æ´ï¼Œå·¥ä½œæµå¤±æ•—"
          echo "é—œéµå•é¡Œæ•¸é‡: ${{ steps.security-check.outputs.critical_issues }}"
          exit 1

  notify-security-team:
    name: Notify Security Team
    runs-on: ubuntu-latest
    needs: [security-report]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
      - name: Send security alert
        uses: actions/github-script@v7
        with:
          script: |
            // é€™è£¡å¯ä»¥æ•´åˆ Slackã€Teams æˆ–å…¶ä»–é€šçŸ¥ç³»çµ±
            console.log('ğŸš¨ å®‰å…¨æƒæå¤±æ•—ï¼Œå·²é€šçŸ¥å®‰å…¨åœ˜éšŠ');
            
            // ç¤ºä¾‹ï¼šç™¼é€åˆ° Slack
            // const webhook = '${{ secrets.SLACK_SECURITY_WEBHOOK }}';
            // if (webhook) {
            //   await fetch(webhook, {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({
            //       text: `ğŸš¨ AI Trading System å®‰å…¨æƒæå¤±æ•—\nåˆ†æ”¯: ${{ github.ref_name }}\næŸ¥çœ‹è©³æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            //     })
            //   });
            // }
