name: Code Quality Check (Optimized)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯æ—¥è‡ªå‹•æª¢æŸ¥ (UTC 02:00 = å°åŒ—æ™‚é–“ 10:00)
    - cron: "0 2 * * *"

env:
  PYTHON_VERSION: "3.10"
  CACHE_VERSION: v2

jobs:
  # å¿«é€Ÿæª¢æŸ¥ - ç¨‹å¼ç¢¼æ ¼å¼å’ŒåŸºæœ¬èªæ³• (~2åˆ†é˜)
  quick-checks:
    name: Quick Checks (Format & Syntax)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
          key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/pyproject.toml', '**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-

      - name: âš¡ Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 autoflake

      - name: â±ï¸ Start timing
        run: echo "QUICK_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: ğŸ¨ Code formatting check (Black)
        run: |
          echo "ğŸ¨ æª¢æŸ¥ç¨‹å¼ç¢¼æ ¼å¼..."
          black --check --diff src/ tests/ || {
            echo "âŒ ç¨‹å¼ç¢¼æ ¼å¼ä¸ç¬¦åˆ Black æ¨™æº–"
            echo "ğŸ’¡ è«‹åŸ·è¡Œ: black src/ tests/"
            exit 1
          }

      - name: ğŸ“¦ Import sorting check (isort)
        run: |
          echo "ğŸ“¦ æª¢æŸ¥å°å…¥æ’åº..."
          isort --check-only --diff src/ tests/ || {
            echo "âŒ å°å…¥æ’åºä¸ç¬¦åˆæ¨™æº–"
            echo "ğŸ’¡ è«‹åŸ·è¡Œ: isort src/ tests/"
            exit 1
          }

      - name: ğŸ” Code style check (Flake8)
        run: |
          echo "ğŸ” åŸ·è¡Œ Flake8 æª¢æŸ¥..."
          flake8 src/ tests/ --statistics --tee --output-file=flake8-report.txt || {
            echo "âŒ Flake8 æª¢æŸ¥ç™¼ç¾å•é¡Œ"
            cat flake8-report.txt
            exit 1
          }

      - name: ğŸ“ File size check
        run: |
          echo "ğŸ“ æª¢æŸ¥æª”æ¡ˆå¤§å°..."
          python -c "
          import os
          import sys

          max_lines = 300
          violations = []

          for root, dirs, files in os.walk('src/'):
              for file in files:
                  if file.endswith('.py'):
                      filepath = os.path.join(root, file)
                      with open(filepath, 'r', encoding='utf-8') as f:
                          line_count = len(f.readlines())
                      
                      if line_count > max_lines:
                          violations.append((filepath, line_count))

          if violations:
              print('âŒ ç™¼ç¾è¶…é 300 è¡Œçš„æª”æ¡ˆ:')
              for filepath, line_count in violations:
                  print(f'  {filepath}: {line_count} è¡Œ')
              sys.exit(1)
          else:
              print('âœ… æ‰€æœ‰æª”æ¡ˆéƒ½ç¬¦åˆ â‰¤300 è¡Œæ¨™æº–')
          "

      - name: â±ï¸ Report quick checks timing
        run: |
          QUICK_END_TIME=$(date +%s)
          QUICK_DURATION=$((QUICK_END_TIME - QUICK_START_TIME))
          echo "âš¡ Quick checks completed in ${QUICK_DURATION}s"
          echo "QUICK_DURATION=${QUICK_DURATION}" >> $GITHUB_ENV

      - name: ğŸ“¤ Upload quick check artifacts
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: quick-check-reports
          path: |
            flake8-report.txt

  # éœæ…‹åˆ†æ - Pylint å’Œ MyPy (~3åˆ†é˜)
  static-analysis:
    name: Static Analysis (Pylint & MyPy)
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: quick-checks

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
          key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/pyproject.toml', '**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-

      - name: âš¡ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry config virtualenvs.create false
          poetry install --with dev,test
          pip install pylint mypy

      - name: â±ï¸ Start timing
        run: echo "STATIC_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: ğŸ”¬ Static analysis (Pylint) - Core modules
        run: |
          echo "ğŸ”¬ åŸ·è¡Œæ ¸å¿ƒæ¨¡çµ„ Pylint åˆ†æ..."
          pylint src/risk_management/ --fail-under=9.0 --output-format=text --reports=yes > pylint-core-report.txt || {
            echo "âŒ æ ¸å¿ƒæ¨¡çµ„ Pylint è©•åˆ†ä½æ–¼ 9.0"
            cat pylint-core-report.txt
            exit 1
          }

      - name: ğŸ”¬ Static analysis (Pylint) - General modules
        run: |
          echo "ğŸ”¬ åŸ·è¡Œä¸€èˆ¬æ¨¡çµ„ Pylint åˆ†æ..."
          pylint src/api/ src/ui/ src/core/ --fail-under=8.5 --output-format=text --reports=yes > pylint-general-report.txt || {
            echo "âŒ ä¸€èˆ¬æ¨¡çµ„ Pylint è©•åˆ†ä½æ–¼ 8.5"
            cat pylint-general-report.txt
            exit 1
          }

      - name: ğŸ·ï¸ Type checking (MyPy)
        run: |
          echo "ğŸ·ï¸ åŸ·è¡Œå‹åˆ¥æª¢æŸ¥..."
          mypy src/ --ignore-missing-imports --show-error-codes --pretty || {
            echo "âŒ MyPy å‹åˆ¥æª¢æŸ¥ç™¼ç¾å•é¡Œ"
            exit 1
          }

      - name: â±ï¸ Report static analysis timing
        run: |
          STATIC_END_TIME=$(date +%s)
          STATIC_DURATION=$((STATIC_END_TIME - STATIC_START_TIME))
          echo "ğŸ”¬ Static analysis completed in ${STATIC_DURATION}s"
          echo "STATIC_DURATION=${STATIC_DURATION}" >> $GITHUB_ENV

      - name: ğŸ“¤ Upload static analysis artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: static-analysis-reports
          path: |
            pylint-*.txt

  # å®‰å…¨æª¢æŸ¥ - Bandit å’Œ Safety (~2åˆ†é˜)
  security-checks:
    name: Security Checks (Bandit & Safety)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: quick-checks

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
          key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/pyproject.toml', '**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-

      - name: âš¡ Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: â±ï¸ Start timing
        run: echo "SECURITY_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: ğŸ”’ Security scan (Bandit)
        run: |
          echo "ğŸ”’ åŸ·è¡Œå®‰å…¨æƒæ..."
          bandit -r src/ -f json -o bandit-report.json || {
            echo "âŒ ç™¼ç¾å®‰å…¨å•é¡Œ"
            bandit -r src/ -f txt
            exit 1
          }

      - name: ğŸ›¡ï¸ Dependency vulnerability check (Safety)
        run: |
          echo "ğŸ›¡ï¸ æª¢æŸ¥ä¾è³´æ¼æ´..."
          safety check --json --output safety-report.json || {
            echo "âŒ ç™¼ç¾ä¾è³´æ¼æ´"
            safety check
            exit 1
          }

      - name: â±ï¸ Report security checks timing
        run: |
          SECURITY_END_TIME=$(date +%s)
          SECURITY_DURATION=$((SECURITY_END_TIME - SECURITY_START_TIME))
          echo "ğŸ”’ Security checks completed in ${SECURITY_DURATION}s"
          echo "SECURITY_DURATION=${SECURITY_DURATION}" >> $GITHUB_ENV

      - name: ğŸ“¤ Upload security reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # æ¸¬è©¦åŸ·è¡Œ - å¤šç‰ˆæœ¬ä¸¦è¡Œ (~4åˆ†é˜)
  tests:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quick-checks
    strategy:
      matrix:
        python-version: [3.8, 3.9, "3.10", "3.11"]
      fail-fast: false

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
          key: ${{ runner.os }}-python-${{ matrix.python-version }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/pyproject.toml', '**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-python-${{ matrix.python-version }}-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-python-${{ matrix.python-version }}-

      - name: âš¡ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry config virtualenvs.create false
          poetry install --with dev,test
          pip install pytest pytest-cov

      - name: â±ï¸ Start timing
        run: echo "TEST_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: ğŸ§ª Run tests with coverage
        run: |
          echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š..."
          pytest tests/ --cov=src/ --cov-report=xml --cov-report=html --cov-report=term-missing --cov-fail-under=80 || {
            echo "âŒ æ¸¬è©¦å¤±æ•—æˆ–è¦†è“‹ç‡ä½æ–¼ 80%"
            exit 1
          }

      - name: â±ï¸ Report test timing
        run: |
          TEST_END_TIME=$(date +%s)
          TEST_DURATION=$((TEST_END_TIME - TEST_START_TIME))
          echo "ğŸ§ª Tests completed in ${TEST_DURATION}s"
          echo "TEST_DURATION=${TEST_DURATION}" >> $GITHUB_ENV

      - name: ğŸ“¤ Upload coverage to Codecov
        if: matrix.python-version == '3.10'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: ğŸ“¤ Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-reports-${{ matrix.python-version }}
          path: |
            coverage.xml
            htmlcov/

  # å“è³ªå ±å‘Šç”Ÿæˆ (~1åˆ†é˜)
  quality-report:
    name: Generate Quality Report
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [static-analysis, security-checks, tests]
    if: always()

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
          key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/pyproject.toml', '**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-

      - name: âš¡ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v3

      - name: â±ï¸ Start timing
        run: echo "REPORT_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: ğŸ“Š Generate quality report
        run: |
          echo "ğŸ“Š ç”Ÿæˆå“è³ªå ±å‘Š..."
          python scripts/generate_quality_report.py

      - name: â±ï¸ Calculate total execution time
        run: |
          REPORT_END_TIME=$(date +%s)
          REPORT_DURATION=$((REPORT_END_TIME - REPORT_START_TIME))
          echo "ğŸ“Š Quality report generated in ${REPORT_DURATION}s"

          # è¨ˆç®—ç¸½åŸ·è¡Œæ™‚é–“ï¼ˆä¼°ç®—ï¼‰
          TOTAL_ESTIMATED_TIME=$((QUICK_DURATION + STATIC_DURATION + SECURITY_DURATION + TEST_DURATION + REPORT_DURATION))
          echo "â±ï¸ Total estimated execution time: ${TOTAL_ESTIMATED_TIME}s"

          if [ $TOTAL_ESTIMATED_TIME -lt 300 ]; then
            echo "ğŸ‰ Performance target achieved! (<5 minutes)"
          else
            echo "âš ï¸ Performance target not met (â‰¥5 minutes)"
          fi

      - name: ğŸ“¤ Upload quality reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: quality-reports
          path: |
            docs/reports/

      - name: ğŸ’¬ Comment PR with quality results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            let comment = '## ğŸ” ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥çµæœ (å„ªåŒ–ç‰ˆ)\n\n';

            // åŸ·è¡Œæ™‚é–“å ±å‘Š
            comment += '### â±ï¸ åŸ·è¡Œæ™‚é–“\n';
            comment += `- å¿«é€Ÿæª¢æŸ¥: ${process.env.QUICK_DURATION || 'N/A'}s\n`;
            comment += `- éœæ…‹åˆ†æ: ${process.env.STATIC_DURATION || 'N/A'}s\n`;
            comment += `- å®‰å…¨æª¢æŸ¥: ${process.env.SECURITY_DURATION || 'N/A'}s\n`;
            comment += `- æ¸¬è©¦åŸ·è¡Œ: ${process.env.TEST_DURATION || 'N/A'}s\n`;
            comment += `- å ±å‘Šç”Ÿæˆ: ${process.env.REPORT_DURATION || 'N/A'}s\n\n`;

            comment += '### ğŸ“Š æª¢æŸ¥ç‹€æ…‹\n';
            comment += 'âœ… å¿«é€Ÿæª¢æŸ¥é€šé\n';
            comment += 'âœ… éœæ…‹åˆ†æé€šé\n';
            comment += 'âœ… å®‰å…¨æª¢æŸ¥é€šé\n';
            comment += 'âœ… æ¸¬è©¦åŸ·è¡Œé€šé\n\n';

            comment += '---\n*æ­¤å ±å‘Šç”±å„ªåŒ–çš„è‡ªå‹•åŒ–å“è³ªæª¢æŸ¥ç³»çµ±ç”Ÿæˆ*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
