name: Monitoring Quality Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/monitoring/**'
      - 'tests/monitoring/**'
      - '.github/workflows/monitoring-quality-check.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/monitoring/**'
      - 'tests/monitoring/**'

jobs:
  quality-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint pytest pytest-cov pytest-mock
        pip install requests prometheus-client grafana-api
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

    - name: Lint monitoring modules with Pylint
      run: |
        cd src
        echo "ğŸ” æª¢æŸ¥ Prometheus æ”¶é›†å™¨..."
        pylint monitoring/prometheus_collector.py --score=y --disable=import-error,no-member
        
        echo "ğŸ” æª¢æŸ¥ Grafana é…ç½®ç®¡ç†å™¨..."
        pylint monitoring/grafana_config.py --score=y --disable=import-error,no-member
        
        echo "ğŸ” æª¢æŸ¥ç›£æ§ç³»çµ±..."
        pylint monitoring/monitor_system.py --score=y --disable=import-error,no-member
        
        echo "ğŸ” æª¢æŸ¥å­æ¨¡çµ„..."
        pylint monitoring/prometheus_modules/ --score=y --disable=import-error,no-member
        pylint monitoring/grafana_modules/ --score=y --disable=import-error,no-member
        pylint monitoring/monitor_modules/ --score=y --disable=import-error,no-member

    - name: Check file size limits
      run: |
        echo "ğŸ“ æª¢æŸ¥æª”æ¡ˆå¤§å°é™åˆ¶ (â‰¤300 è¡Œ)..."
        
        check_file_size() {
          local file=$1
          local max_lines=300
          
          if [ -f "$file" ]; then
            local lines=$(wc -l < "$file")
            echo "  $file: $lines è¡Œ"
            
            if [ $lines -gt $max_lines ]; then
              echo "  âŒ æª”æ¡ˆéå¤§: $lines > $max_lines è¡Œ"
              return 1
            else
              echo "  âœ… æª”æ¡ˆå¤§å°ç¬¦åˆè¦æ±‚"
              return 0
            fi
          else
            echo "  âš ï¸ æª”æ¡ˆä¸å­˜åœ¨: $file"
            return 1
          fi
        }
        
        cd src
        failed=0
        
        # æª¢æŸ¥ä¸»è¦æª”æ¡ˆ
        check_file_size "monitoring/prometheus_collector.py" || failed=1
        check_file_size "monitoring/grafana_config.py" || failed=1
        check_file_size "monitoring/monitor_system.py" || failed=1
        
        # æª¢æŸ¥å­æ¨¡çµ„æª”æ¡ˆ
        for file in monitoring/prometheus_modules/*.py; do
          [ "$file" != "monitoring/prometheus_modules/__init__.py" ] && check_file_size "$file" || failed=1
        done
        
        for file in monitoring/grafana_modules/*.py; do
          [ "$file" != "monitoring/grafana_modules/__init__.py" ] && check_file_size "$file" || failed=1
        done
        
        for file in monitoring/monitor_modules/*.py; do
          [ "$file" != "monitoring/monitor_modules/__init__.py" ] && check_file_size "$file" || failed=1
        done
        
        if [ $failed -eq 1 ]; then
          echo "âŒ æª”æ¡ˆå¤§å°æª¢æŸ¥å¤±æ•—"
          exit 1
        else
          echo "âœ… æ‰€æœ‰æª”æ¡ˆå¤§å°ç¬¦åˆè¦æ±‚"
        fi

    - name: Run monitoring tests
      run: |
        echo "ğŸ§ª åŸ·è¡Œç›£æ§æ¨¡çµ„æ¸¬è©¦..."
        python -m pytest tests/monitoring/ -v --tb=short
      continue-on-error: true

    - name: Run tests with coverage
      run: |
        echo "ğŸ“Š åŸ·è¡Œæ¸¬è©¦è¦†è“‹ç‡æª¢æŸ¥..."
        python -m pytest tests/monitoring/ \
          --cov=src/monitoring \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-fail-under=70 \
          -v
      continue-on-error: true

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.10'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: monitoring
        name: monitoring-coverage
        fail_ci_if_error: false

    - name: Check Pylint scores
      run: |
        echo "ğŸ“ˆ æª¢æŸ¥ Pylint è©•åˆ†è¦æ±‚ (â‰¥9.0/10)..."
        
        cd src
        
        # æª¢æŸ¥ä¸»è¦æ¨¡çµ„çš„ Pylint è©•åˆ†
        check_pylint_score() {
          local file=$1
          local min_score=9.0
          
          echo "æª¢æŸ¥ $file..."
          local output=$(pylint "$file" --score=y --disable=import-error,no-member 2>&1)
          local score=$(echo "$output" | grep "Your code has been rated at" | sed 's/.*rated at \([0-9.]*\).*/\1/')
          
          if [ -z "$score" ]; then
            echo "  âš ï¸ ç„¡æ³•ç²å–è©•åˆ†"
            return 1
          fi
          
          echo "  è©•åˆ†: $score/10"
          
          # ä½¿ç”¨ awk é€²è¡Œæµ®é»æ•¸æ¯”è¼ƒ
          if awk "BEGIN {exit !($score >= $min_score)}"; then
            echo "  âœ… è©•åˆ†ç¬¦åˆè¦æ±‚ (â‰¥$min_score)"
            return 0
          else
            echo "  âŒ è©•åˆ†ä¸ç¬¦åˆè¦æ±‚ ($score < $min_score)"
            return 1
          fi
        }
        
        failed=0
        
        check_pylint_score "monitoring/prometheus_collector.py" || failed=1
        check_pylint_score "monitoring/grafana_config.py" || failed=1
        check_pylint_score "monitoring/monitor_system.py" || failed=1
        
        if [ $failed -eq 1 ]; then
          echo "âŒ Pylint è©•åˆ†æª¢æŸ¥å¤±æ•—"
          exit 1
        else
          echo "âœ… æ‰€æœ‰æ¨¡çµ„ Pylint è©•åˆ†ç¬¦åˆè¦æ±‚"
        fi

    - name: Generate quality report
      if: always()
      run: |
        echo "ğŸ“‹ ç”Ÿæˆå“è³ªå ±å‘Š..."
        
        cat > quality_report.md << 'EOF'
        # ç›£æ§æ¨¡çµ„å“è³ªæª¢æŸ¥å ±å‘Š
        
        ## æª¢æŸ¥é …ç›®
        
        ### âœ… å·²æª¢æŸ¥é …ç›®
        - [x] Pylint ç¨‹å¼ç¢¼å“è³ª (â‰¥9.0/10)
        - [x] æª”æ¡ˆå¤§å°é™åˆ¶ (â‰¤300 è¡Œ)
        - [x] æ¸¬è©¦åŸ·è¡Œ
        - [x] æ¸¬è©¦è¦†è“‹ç‡ (ç›®æ¨™ â‰¥70%)
        
        ### ğŸ“Š å“è³ªæŒ‡æ¨™
        - **Python ç‰ˆæœ¬**: ${{ matrix.python-version }}
        - **æª¢æŸ¥æ™‚é–“**: $(date)
        - **åˆ†æ”¯**: ${{ github.ref }}
        - **æäº¤**: ${{ github.sha }}
        
        ### ğŸ” æª¢æŸ¥ç¯„åœ
        - `src/monitoring/prometheus_collector.py`
        - `src/monitoring/grafana_config.py`
        - `src/monitoring/monitor_system.py`
        - `src/monitoring/prometheus_modules/`
        - `src/monitoring/grafana_modules/`
        - `src/monitoring/monitor_modules/`
        
        EOF
        
        echo "å“è³ªå ±å‘Šå·²ç”Ÿæˆ"

    - name: Comment PR with quality report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('quality_report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });

  security-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run security checks
      run: |
        echo "ğŸ”’ åŸ·è¡Œå®‰å…¨æª¢æŸ¥..."
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ç¡¬ç·¨ç¢¼çš„æ•æ„Ÿè³‡è¨Š
        echo "æª¢æŸ¥ç¡¬ç·¨ç¢¼å¯†ç¢¼å’Œ API é‡‘é‘°..."
        if grep -r -i "password\|api_key\|secret\|token" src/monitoring/ --include="*.py" | grep -v "# " | grep -v "\"\"\""; then
          echo "âš ï¸ ç™¼ç¾å¯èƒ½çš„ç¡¬ç·¨ç¢¼æ•æ„Ÿè³‡è¨Š"
        else
          echo "âœ… æœªç™¼ç¾ç¡¬ç·¨ç¢¼æ•æ„Ÿè³‡è¨Š"
        fi
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ä¸å®‰å…¨çš„å°å…¥
        echo "æª¢æŸ¥ä¸å®‰å…¨çš„å°å…¥..."
        if grep -r "import os" src/monitoring/ --include="*.py" | grep -v "# "; then
          echo "âš ï¸ ç™¼ç¾ os æ¨¡çµ„å°å…¥ï¼Œè«‹ç¢ºä¿å®‰å…¨ä½¿ç”¨"
        fi
        
        echo "âœ… å®‰å…¨æª¢æŸ¥å®Œæˆ"
