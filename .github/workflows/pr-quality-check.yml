name: PR Quality Check

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  pr-quality-analysis:
    name: PR Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²ä»¥é€²è¡Œå·®ç•°åˆ†æ
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install
          
      - name: Create reports directory
        run: |
          mkdir -p reports/pr
          
      - name: Analyze changed files
        run: |
          poetry run python scripts/analyze_pr_changes.py --output reports/pr/changes_analysis.json
          
      - name: Run quality checks on changed files
        run: |
          poetry run python scripts/pr_quality_check.py --output reports/pr/quality_report.md
          
      - name: Upload PR analysis report
        uses: actions/upload-artifact@v4
        with:
          name: pr-quality-report-${{ github.event.number }}
          path: reports/pr/
          
      - name: Comment PR with quality report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              const reportPath = 'reports/pr/quality_report.md';
              if (fs.existsSync(reportPath)) {
                const report = fs.readFileSync(reportPath, 'utf8');
                
                // æŸ¥æ‰¾ç¾æœ‰çš„å“è³ªå ±å‘Šè©•è«–
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                });
                
                const botComment = comments.data.find(comment => 
                  comment.user.type === 'Bot' && 
                  comment.body.includes('ğŸ” PRå“è³ªæª¢æŸ¥å ±å‘Š')
                );
                
                const commentBody = `ğŸ” **PRå“è³ªæª¢æŸ¥å ±å‘Š**
                
${report}

---
*æ­¤å ±å‘Šç”±è‡ªå‹•åŒ–ç³»çµ±ç”Ÿæˆ - é‹è¡Œ #${context.runNumber}*`;
                
                if (botComment) {
                  // æ›´æ–°ç¾æœ‰è©•è«–
                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: botComment.id,
                    body: commentBody
                  });
                } else {
                  // å‰µå»ºæ–°è©•è«–
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: commentBody
                  });
                }
              }
            } catch (error) {
              console.log('ç„¡æ³•è®€å–æˆ–ç™¼å¸ƒå“è³ªå ±å‘Š:', error);
            }
            
      - name: Add quality labels
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              const analysisPath = 'reports/pr/changes_analysis.json';
              if (fs.existsSync(analysisPath)) {
                const analysis = JSON.parse(fs.readFileSync(analysisPath, 'utf8'));
                
                const labels = [];
                
                // æ ¹æ“šåˆ†æçµæœæ·»åŠ æ¨™ç±¤
                if (analysis.has_large_files) {
                  labels.push('needs-refactoring');
                }
                
                if (analysis.quality_score < 8.5) {
                  labels.push('needs-improvement');
                }
                
                if (analysis.test_coverage < 80) {
                  labels.push('needs-tests');
                }
                
                if (analysis.security_issues > 0) {
                  labels.push('security-review');
                }
                
                if (labels.length === 0) {
                  labels.push('quality-approved');
                }
                
                // æ·»åŠ æ¨™ç±¤
                if (labels.length > 0) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    labels: labels
                  });
                }
              }
            } catch (error) {
              console.log('ç„¡æ³•æ·»åŠ å“è³ªæ¨™ç±¤:', error);
            }
            
      - name: Request changes if quality issues found
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'REQUEST_CHANGES',
              body: `## âš ï¸ å“è³ªæª¢æŸ¥ç™¼ç¾å•é¡Œ

æ­¤PRæœªé€šéè‡ªå‹•åŒ–å“è³ªæª¢æŸ¥ï¼Œè«‹ä¿®å¾©ä»¥ä¸‹å•é¡Œå¾Œé‡æ–°æäº¤ï¼š

- æª”æ¡ˆå¤§å°è¶…é300è¡Œé™åˆ¶
- Pylintåˆ†æ•¸ä½æ–¼8.5
- æ¸¬è©¦è¦†è“‹ç‡ä½æ–¼80%
- å®‰å…¨æª¢æŸ¥ç™¼ç¾å•é¡Œ

è«‹æŸ¥çœ‹è©³ç´°çš„å“è³ªå ±å‘Šä¸¦ä¿®å¾©ç›¸é—œå•é¡Œã€‚`
            });
            
      - name: Approve if all checks pass
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: `## âœ… è‡ªå‹•åŒ–å“è³ªæª¢æŸ¥é€šé

æ­¤PRå·²é€šéæ‰€æœ‰è‡ªå‹•åŒ–å“è³ªæª¢æŸ¥ï¼š

- âœ… æª”æ¡ˆå¤§å°ç¬¦åˆâ‰¤300è¡Œæ¨™æº–
- âœ… Pylintåˆ†æ•¸â‰¥8.5
- âœ… æ¸¬è©¦è¦†è“‹ç‡â‰¥80%
- âœ… å®‰å…¨æª¢æŸ¥é€šé

å¯ä»¥é€²è¡Œäººå·¥å¯©æŸ¥å’Œåˆä½µã€‚`
            });
