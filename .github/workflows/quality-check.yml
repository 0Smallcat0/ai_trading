name: Code Quality Check (Optimized)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯æ—¥è‡ªå‹•æª¢æŸ¥ (UTC 02:00 = å°åŒ—æ™‚é–“ 10:00)
    - cron: "0 2 * * *"

env:
  PYTHON_VERSION: "3.10"
  CACHE_VERSION: v2

jobs:
  # å¿«é€Ÿæª¢æŸ¥ - ç¨‹å¼ç¢¼æ ¼å¼å’ŒåŸºæœ¬èªæ³•
  quick-checks:
    name: Quick Checks (Format & Syntax)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
          key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/pyproject.toml', '**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-

      - name: âš¡ Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 autoflake

      - name: â±ï¸ Start timing
        run: echo "QUICK_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry config virtualenvs.create false
          poetry install --with dev,test

          # å®‰è£å“è³ªæª¢æŸ¥å·¥å…·
          pip install pylint flake8 black isort mypy bandit safety pytest pytest-cov

      - name: Code formatting check (Black)
        run: |
          echo "ğŸ¨ æª¢æŸ¥ç¨‹å¼ç¢¼æ ¼å¼..."
          black --check --diff src/ tests/ || {
            echo "âŒ ç¨‹å¼ç¢¼æ ¼å¼ä¸ç¬¦åˆ Black æ¨™æº–"
            echo "ğŸ’¡ è«‹åŸ·è¡Œ: black src/ tests/"
            exit 1
          }

      - name: Import sorting check (isort)
        run: |
          echo "ğŸ“¦ æª¢æŸ¥å°å…¥æ’åº..."
          isort --check-only --diff src/ tests/ || {
            echo "âŒ å°å…¥æ’åºä¸ç¬¦åˆæ¨™æº–"
            echo "ğŸ’¡ è«‹åŸ·è¡Œ: isort src/ tests/"
            exit 1
          }

      - name: Linting (Flake8)
        run: |
          echo "ğŸ” åŸ·è¡Œ Flake8 æª¢æŸ¥..."
          flake8 src/ tests/ --statistics --tee --output-file=flake8-report.txt || {
            echo "âŒ Flake8 æª¢æŸ¥ç™¼ç¾å•é¡Œ"
            cat flake8-report.txt
            exit 1
          }

      - name: Static analysis (Pylint)
        run: |
          echo "ğŸ”¬ åŸ·è¡Œ Pylint éœæ…‹åˆ†æ..."

          # æ ¸å¿ƒæ¨¡çµ„éœ€è¦æ›´é«˜æ¨™æº– (â‰¥9.0)
          echo "æª¢æŸ¥æ ¸å¿ƒæ¨¡çµ„..."
          pylint src/risk_management/ --fail-under=9.0 --output-format=text --reports=yes > pylint-core-report.txt || {
            echo "âŒ æ ¸å¿ƒæ¨¡çµ„ Pylint è©•åˆ†ä½æ–¼ 9.0"
            cat pylint-core-report.txt
            exit 1
          }

          # å…¶ä»–æ¨¡çµ„æ¨™æº– (â‰¥8.5)
          echo "æª¢æŸ¥å…¶ä»–æ¨¡çµ„..."
          pylint src/api/ src/ui/ src/core/ --fail-under=8.5 --output-format=text --reports=yes > pylint-general-report.txt || {
            echo "âŒ ä¸€èˆ¬æ¨¡çµ„ Pylint è©•åˆ†ä½æ–¼ 8.5"
            cat pylint-general-report.txt
            exit 1
          }

      - name: Type checking (MyPy)
        run: |
          echo "ğŸ·ï¸ åŸ·è¡Œå‹åˆ¥æª¢æŸ¥..."
          mypy src/ --ignore-missing-imports --show-error-codes --pretty || {
            echo "âŒ MyPy å‹åˆ¥æª¢æŸ¥ç™¼ç¾å•é¡Œ"
            exit 1
          }

      - name: Security scan (Bandit)
        run: |
          echo "ğŸ”’ åŸ·è¡Œå®‰å…¨æƒæ..."
          bandit -r src/ -f json -o bandit-report.json || {
            echo "âŒ ç™¼ç¾å®‰å…¨å•é¡Œ"
            bandit -r src/ -f txt
            exit 1
          }

      - name: Dependency vulnerability check (Safety)
        run: |
          echo "ğŸ›¡ï¸ æª¢æŸ¥ä¾è³´æ¼æ´..."
          safety check --json --output safety-report.json || {
            echo "âŒ ç™¼ç¾ä¾è³´æ¼æ´"
            safety check
            exit 1
          }

      - name: File size check
        run: |
          echo "ğŸ“ æª¢æŸ¥æª”æ¡ˆå¤§å°..."
          python -c "
          import os
          import sys

          max_lines = 300
          violations = []

          for root, dirs, files in os.walk('src/'):
              for file in files:
                  if file.endswith('.py'):
                      filepath = os.path.join(root, file)
                      with open(filepath, 'r', encoding='utf-8') as f:
                          line_count = len(f.readlines())
                      
                      if line_count > max_lines:
                          violations.append((filepath, line_count))

          if violations:
              print('âŒ ç™¼ç¾è¶…é 300 è¡Œçš„æª”æ¡ˆ:')
              for filepath, line_count in violations:
                  print(f'  {filepath}: {line_count} è¡Œ')
              sys.exit(1)
          else:
              print('âœ… æ‰€æœ‰æª”æ¡ˆéƒ½ç¬¦åˆ â‰¤300 è¡Œæ¨™æº–')
          "

      - name: Run tests with coverage
        run: |
          echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š..."
          pytest tests/ --cov=src/ --cov-report=xml --cov-report=html --cov-report=term-missing --cov-fail-under=80 || {
            echo "âŒ æ¸¬è©¦å¤±æ•—æˆ–è¦†è“‹ç‡ä½æ–¼ 80%"
            exit 1
          }

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.10'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Generate quality report
        if: always()
        run: |
          echo "ğŸ“Š ç”Ÿæˆå“è³ªå ±å‘Š..."
          python scripts/generate_quality_report.py

      - name: Upload quality reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: quality-reports-${{ matrix.python-version }}
          path: |
            pylint-*.txt
            flake8-report.txt
            bandit-report.json
            safety-report.json
            coverage.xml
            htmlcov/
            quality-report.html

      - name: Comment PR with quality results
        if: github.event_name == 'pull_request' && matrix.python-version == '3.10'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            // è®€å–å“è³ªå ±å‘Š
            let comment = '## ğŸ” ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥çµæœ\n\n';

            try {
              // Pylint çµæœ
              const pylintCore = fs.readFileSync('pylint-core-report.txt', 'utf8');
              const pylintGeneral = fs.readFileSync('pylint-general-report.txt', 'utf8');
              
              // æå–è©•åˆ†
              const coreScore = pylintCore.match(/Your code has been rated at ([\d.]+)\/10/);
              const generalScore = pylintGeneral.match(/Your code has been rated at ([\d.]+)\/10/);
              
              comment += '### ğŸ“Š Pylint è©•åˆ†\n';
              comment += `- æ ¸å¿ƒæ¨¡çµ„: ${coreScore ? coreScore[1] : 'N/A'}/10 (è¦æ±‚ â‰¥9.0)\n`;
              comment += `- ä¸€èˆ¬æ¨¡çµ„: ${generalScore ? generalScore[1] : 'N/A'}/10 (è¦æ±‚ â‰¥8.5)\n\n`;
              
              // æª”æ¡ˆå¤§å°æª¢æŸ¥çµæœ
              comment += '### ğŸ“ æª”æ¡ˆå¤§å°æª¢æŸ¥\n';
              comment += 'âœ… æ‰€æœ‰æª”æ¡ˆéƒ½ç¬¦åˆ â‰¤300 è¡Œæ¨™æº–\n\n';
              
              comment += '### ğŸ§ª æ¸¬è©¦è¦†è“‹ç‡\n';
              comment += 'è©³ç´°è¦†è“‹ç‡å ±å‘Šè«‹æŸ¥çœ‹ Artifacts\n\n';
              
              comment += '### ğŸ”’ å®‰å…¨æª¢æŸ¥\n';
              comment += 'âœ… é€šé Bandit å®‰å…¨æƒæ\n';
              comment += 'âœ… é€šé Safety ä¾è³´æª¢æŸ¥\n\n';
              
            } catch (error) {
              comment += 'âŒ ç„¡æ³•è®€å–å“è³ªå ±å‘Šæª”æ¡ˆ\n\n';
            }

            comment += '---\n*æ­¤å ±å‘Šç”±è‡ªå‹•åŒ–å“è³ªæª¢æŸ¥ç³»çµ±ç”Ÿæˆ*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  performance-test:
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install poetry
          poetry install --with dev,test
          pip install pytest-benchmark

      - name: Run performance tests
        run: |
          echo "âš¡ åŸ·è¡Œæ€§èƒ½æ¸¬è©¦..."
          pytest tests/performance/ --benchmark-only --benchmark-json=benchmark.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: benchmark.json
